<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of BaseOfSupport</title>
  <meta name="keywords" content="BaseOfSupport">
  <meta name="description" content="Computation of the base of support">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html Functions --><!-- ../menu.html Developments --><!-- menu.html ComplementaryData -->
<h1>BaseOfSupport
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>Computation of the base of support</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [] = BaseOfSupport(AnalysisParameters) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Computation of the base of support

   INPUT
   - AnalysisParameters: parameters of the musculoskeletal analysis,
   automatically generated by the graphic interface 'Analysis'.
   OUTPUT
   The data related to the base of support are automatically saved on the
   folder associated to each motion capture in variables
   'InverseKinematicsResults'
________________________________________________________

 Licence
 Toolbox distributed under GPL 3.0 Licence
________________________________________________________

 Authors : Antoine Muller, Charles Pontonnier, Pierre Puchaud and
 Georges Dumont
________________________________________________________</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../Functions/AlgoMathsModel/Rodrigues.html" class="code" title="function R = Rodrigues(a,q)">Rodrigues</a>	Computation of the Rodrigues equation</li><li><a href="../../../Functions/AlgoMathsModel/derivee2.html" class="code" title="function yp=derivee2(h,y)">derivee2</a>	2-order numerical derivative</li><li><a href="../../../Functions/ExternalForces/Prediction/ForwardAllKinematicsPrediction.html" class="code" title="function [Human_model,Prediction] = ForwardAllKinematicsPrediction(Human_model,Prediction,j)">ForwardAllKinematicsPrediction</a>	Computation of spacial position, velocity and acceleration for each solid used for the prediction of ground reaction forces</li><li><a href="../../../Functions/ExternalForces/Prediction/verif_Prediction_Humanmodel.html" class="code" title="function [Prediction]=verif_Prediction_Humanmodel(Human_model,Prediction)">verif_Prediction_Humanmodel</a>	Verification that each contact point on Prediction is correctly defined on the osteo-articular model</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [] = BaseOfSupport(AnalysisParameters)</a>
0002 <span class="comment">% Computation of the base of support</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%   INPUT</span>
0005 <span class="comment">%   - AnalysisParameters: parameters of the musculoskeletal analysis,</span>
0006 <span class="comment">%   automatically generated by the graphic interface 'Analysis'.</span>
0007 <span class="comment">%   OUTPUT</span>
0008 <span class="comment">%   The data related to the base of support are automatically saved on the</span>
0009 <span class="comment">%   folder associated to each motion capture in variables</span>
0010 <span class="comment">%   'InverseKinematicsResults'</span>
0011 <span class="comment">%________________________________________________________</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% Licence</span>
0014 <span class="comment">% Toolbox distributed under GPL 3.0 Licence</span>
0015 <span class="comment">%________________________________________________________</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% Authors : Antoine Muller, Charles Pontonnier, Pierre Puchaud and</span>
0018 <span class="comment">% Georges Dumont</span>
0019 <span class="comment">%________________________________________________________</span>
0020 
0021 <span class="comment">%%</span>
0022 <span class="comment">% Thresholds</span>
0023 
0024 PositionThreshold = AnalysisParameters.Prediction.PositionThreshold;
0025 VelocityThreshold = AnalysisParameters.Prediction.VelocityThreshold;
0026 
0027 <span class="keyword">for</span> num_f = 1:numel(AnalysisParameters.filename) <span class="comment">% for each file</span>
0028     <span class="comment">%% Loading data</span>
0029     filename = AnalysisParameters.filename{num_f}(1:end-(numel(AnalysisParameters.General.Extension)-1));
0030     load(<span class="string">'BiomechanicalModel.mat'</span>) <span class="comment">%#ok&lt;LOAD&gt;</span>
0031     Human_model = BiomechanicalModel.OsteoArticularModel;
0032     load([filename <span class="string">'/InverseKinematicsResults.mat'</span>]); <span class="comment">%#ok&lt;LOAD&gt;</span>
0033     q = InverseKinematicsResults.JointCoordinates';
0034     <span class="keyword">if</span> isfield(InverseKinematicsResults,<span class="string">'FreeJointCoordinates'</span>)
0035         q6dof = InverseKinematicsResults.FreeJointCoordinates';
0036     <span class="keyword">else</span>
0037         PelvisPosition = InverseKinematicsResults.PelvisPosition;
0038         PelvisOrientation = InverseKinematicsResults.PelvisOrientation;
0039     <span class="keyword">end</span>        
0040     load([filename <span class="string">'/ExperimentalData.mat'</span>]); <span class="comment">%#ok&lt;LOAD&gt;</span>
0041     time = ExperimentalData.Time;
0042     dt=time(2);
0043 
0044     <span class="comment">%% Base of support</span>
0045     <span class="comment">% Creation of contact points (all anatomical points of the model)</span>
0046     ContactPoint = cell(0);
0047     <span class="keyword">for</span> m=1:numel(Human_model)
0048         <span class="keyword">if</span> numel(Human_model(m).anat_position)
0049             ContactPoint = [ContactPoint; Human_model(m).anat_position(:,1)]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0050         <span class="keyword">end</span>
0051     <span class="keyword">end</span>
0052     NbPointsPrediction = numel(ContactPoint); <span class="comment">% Number of ground contact points</span>
0053     <span class="keyword">for</span> l=1:NbPointsPrediction
0054         Prediction(l).points_prediction_efforts = ContactPoint{l}; <span class="comment">%#ok&lt;AGROW&gt;</span>
0055     <span class="keyword">end</span>
0056     Prediction=<a href="../../../Functions/ExternalForces/Prediction/verif_Prediction_Humanmodel.html" class="code" title="function [Prediction]=verif_Prediction_Humanmodel(Human_model,Prediction)">verif_Prediction_Humanmodel</a>(Human_model,Prediction);  
0057     
0058     <span class="comment">% get rid of the 6DOF joint</span>
0059     <span class="keyword">if</span> isfield(InverseKinematicsResults,<span class="string">'FreeJointCoordinates'</span>)
0060         Human_model(Human_model(end).child).mother = 0;
0061         Human_model=Human_model(1:(numel(Human_model)-6));
0062     <span class="keyword">end</span>
0063     
0064     <span class="comment">% Velocity and acceleration for every joint</span>
0065     dq=<a href="../../../Functions/AlgoMathsModel/derivee2.html" class="code" title="function yp=derivee2(h,y)">derivee2</a>(dt,q);  <span class="comment">% velocities</span>
0066     ddq=<a href="../../../Functions/AlgoMathsModel/derivee2.html" class="code" title="function yp=derivee2(h,y)">derivee2</a>(dt,dq);  <span class="comment">% accelerations</span>
0067     nbframe=size(q,1);
0068     
0069     <span class="comment">% Kinematical data for Pelvis (Position/speed/acceleration/angles/angular speed/angular acceleration)</span>
0070     <span class="keyword">if</span> isfield(InverseKinematicsResults,<span class="string">'FreeJointCoordinates'</span>)
0071         p_pelvis=q6dof(:,1:3);  <span class="comment">% frame i : p_pelvis(i,:)</span>
0072         r_pelvis=cell(size(q6dof,1),1);
0073         <span class="keyword">for</span> i=1:size(q6dof,1)
0074             r_pelvis{i}=<a href="../../../Functions/AlgoMathsModel/Rodrigues.html" class="code" title="function R = Rodrigues(a,q)">Rodrigues</a>([1 0 0]',q6dof(i,4))*<a href="../../../Functions/AlgoMathsModel/Rodrigues.html" class="code" title="function R = Rodrigues(a,q)">Rodrigues</a>([0 1 0]',q6dof(i,5))*<a href="../../../Functions/AlgoMathsModel/Rodrigues.html" class="code" title="function R = Rodrigues(a,q)">Rodrigues</a>([0 0 1]',q6dof(i,6)); <span class="comment">% matrice de rotation en fonction des rotations successives (x,y,z) : frame i : r_pelvis{i}</span>
0075         <span class="keyword">end</span>
0076     <span class="keyword">else</span>
0077         p_pelvis = cell2mat(PelvisPosition)';
0078         r_pelvis  = PelvisOrientation';
0079     <span class="keyword">end</span>
0080     <span class="comment">%dR</span>
0081     dR=zeros(3,3,nbframe);
0082     <span class="keyword">for</span> ligne=1:3
0083         <span class="keyword">for</span> colonne=1:3
0084             dR(ligne,colonne,:)=<a href="../../../Functions/AlgoMathsModel/derivee2.html" class="code" title="function yp=derivee2(h,y)">derivee2</a>(dt,cell2mat(cellfun(@(b) b(ligne,colonne),r_pelvis,<span class="string">'UniformOutput'</span>,false)));
0085             dR(ligne,colonne,:)=<a href="../../../Functions/AlgoMathsModel/derivee2.html" class="code" title="function yp=derivee2(h,y)">derivee2</a>(dt,cell2mat(cellfun(@(b) b(ligne,colonne),r_pelvis,<span class="string">'UniformOutput'</span>,false)));
0086             dR(ligne,colonne,:)=<a href="../../../Functions/AlgoMathsModel/derivee2.html" class="code" title="function yp=derivee2(h,y)">derivee2</a>(dt,cell2mat(cellfun(@(b) b(ligne,colonne),r_pelvis,<span class="string">'UniformOutput'</span>,false)));
0087         <span class="keyword">end</span>
0088     <span class="keyword">end</span>
0089     w=zeros(nbframe,3);
0090     <span class="keyword">for</span> i=1:nbframe
0091         wmat=dR(:,:,i)*r_pelvis{i}';
0092         w(i,:)=[wmat(3,2),wmat(1,3),wmat(2,1)];
0093     <span class="keyword">end</span>
0094     <span class="comment">% v0</span>
0095     v=<a href="../../../Functions/AlgoMathsModel/derivee2.html" class="code" title="function yp=derivee2(h,y)">derivee2</a>(dt,p_pelvis);
0096     vw=zeros(nbframe,3);
0097     <span class="keyword">for</span> i=1:nbframe
0098         vw(i,:)=cross(p_pelvis(i,:),w(i,:));
0099     <span class="keyword">end</span>
0100     v0=v+vw;
0101     <span class="comment">% dv0</span>
0102     dv0=<a href="../../../Functions/AlgoMathsModel/derivee2.html" class="code" title="function yp=derivee2(h,y)">derivee2</a>(dt,v0);
0103     <span class="comment">% dw</span>
0104     dw=<a href="../../../Functions/AlgoMathsModel/derivee2.html" class="code" title="function yp=derivee2(h,y)">derivee2</a>(dt,w);
0105 
0106     <span class="comment">% Forward kinematics</span>
0107     BoS = cell(1,nbframe);
0108     <span class="keyword">for</span> i=1:nbframe
0109         Human_model(1).p = p_pelvis(i,:)';
0110         Human_model(1).R = r_pelvis{i};
0111         Human_model(1).v0 = v0(i,:)';
0112         Human_model(1).w = w(i,:)';
0113         Human_model(1).dv0 = dv0(i,:)';
0114         Human_model(1).dw = dw(i,:)';
0115         <span class="keyword">for</span> j=2:numel(Human_model)
0116             Human_model(j).q=q(i,j);
0117             Human_model(j).dq=dq(i,j);
0118             Human_model(j).ddq=ddq(i,j);
0119         <span class="keyword">end</span>
0120         [~,Prediction] = <a href="../../../Functions/ExternalForces/Prediction/ForwardAllKinematicsPrediction.html" class="code" title="function [Human_model,Prediction] = ForwardAllKinematicsPrediction(Human_model,Prediction,j)">ForwardAllKinematicsPrediction</a>(Human_model,Prediction,1); 
0121         
0122         <span class="comment">% Testing contact points</span>
0123         ActivePoints = zeros(numel(Prediction),1);
0124         <span class="keyword">for</span> l=1:numel(Prediction)
0125             ActivePoints(l,:) = (Prediction(l).pos_anim(3) &lt; PositionThreshold) &amp;&amp; (norm(Prediction(l).vitesse) &lt; VelocityThreshold);
0126         <span class="keyword">end</span>
0127         <span class="comment">% Base of support</span>
0128         <span class="keyword">if</span> sum(ActivePoints)&gt;3
0129             PosPoints = [Prediction(find(ActivePoints)).pos_anim]; <span class="comment">%#ok&lt;FNDSB&gt;</span>
0130             h = convhull(PosPoints(1,:), PosPoints(2,:));
0131             BoS{i} = PosPoints(:,h);
0132         <span class="keyword">end</span>        
0133     <span class="keyword">end</span>
0134     
0135     <span class="comment">% Saving data</span>
0136     InverseKinematicsResults.BoS = BoS;
0137     save([filename <span class="string">'/InverseKinematicsResults.mat'</span>], <span class="string">'InverseKinematicsResults'</span>);
0138     
0139 <span class="keyword">end</span>
0140 
0141 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Wed 28-Apr-2021 14:02:00 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>