<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of print2eps</title>
  <meta name="keywords" content="print2eps">
  <meta name="description" content="PRINT2EPS  Prints figures to eps with improved line styles">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html Functions --><!-- # ExternLibrary --><!-- menu.html export_fig -->
<h1>print2eps
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>PRINT2EPS  Prints figures to eps with improved line styles</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function print2eps(name, fig, export_options, varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">PRINT2EPS  Prints figures to eps with improved line styles

 Examples:
   print2eps filename
   print2eps(filename, fig_handle)
   print2eps(filename, fig_handle, export_options)
   print2eps(filename, fig_handle, export_options, print_options)

 This function saves a figure as an eps file, with two improvements over
 MATLAB's print command. First, it improves the line style, making dashed
 lines more like those on screen and giving grid lines a dotted line style.
 Secondly, it substitutes original font names back into the eps file,
 where these have been changed by MATLAB, for up to 11 different fonts.

IN:
   filename - string containing the name (optionally including full or
              relative path) of the file the figure is to be saved as. A
              &quot;.eps&quot; extension is added if not there already. If a path is
              not specified, the figure is saved in the current directory.
   fig_handle - The handle of the figure to be saved. Default: gcf().
   export_options - array or struct of optional scalar values:
       bb_padding - Scalar value of amount of padding to add to border around
                    the cropped image, in points (if &gt;1) or percent (if &lt;1).
                    Can be negative as well as positive; Default: 0
       crop       - Cropping flag. Deafult: 0
       fontswap   - Whether to swap non-default fonts in figure. Default: true
       font_space - Character used to separate font-name terms in the EPS output
                    e.g. &quot;Courier New&quot; =&gt; &quot;Courier-New&quot;. Default: ''
                    (available only via the struct alternative)
       renderer   - Renderer used to generate bounding-box. Default: 'opengl'
                    (available only via the struct alternative)
       crop_amounts - 4-element vector of crop amounts: [top,right,bottom,left]
                    (available only via the struct alternative)
   print_options - Additional parameter strings to be passed to the print command</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="crop_borders.html" class="code" title="function [A, vA, vB, bb_rel] = crop_borders(A, bcol, padding, crop_amounts)">crop_borders</a>	CROP_BORDERS Crop the borders of an image or stack of images</li><li><a href="fix_lines.html" class="code" title="function fstrm = fix_lines(fstrm, fname2)">fix_lines</a>	FIX_LINES  Improves the line style of eps files generated by print</li><li><a href="print2array.html" class="code" title="function [A, bcol] = print2array(fig, res, renderer, gs_options)">print2array</a>	PRINT2ARRAY  Exports a figure to an image array</li><li><a href="read_write_entire_textfile.html" class="code" title="function fstrm = read_write_entire_textfile(fname, fstrm)">read_write_entire_textfile</a>	READ_WRITE_ENTIRE_TEXTFILE Read or write a whole text file to/from memory</li><li><a href="using_hg2.html" class="code" title="function tf = using_hg2(fig)">using_hg2</a>	USING_HG2 Determine if the HG2 graphics engine is used</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="export_fig.html" class="code" title="function [imageData, alpha] = export_fig(varargin) %#ok<*STRCL1>">export_fig</a>	EXPORT_FIG  Exports figures in a publication-quality format</li><li><a href="print2array.html" class="code" title="function [A, bcol] = print2array(fig, res, renderer, gs_options)">print2array</a>	PRINT2ARRAY  Exports a figure to an image array</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [StoredColors, fstrm, foundFlags] = eps_maintainAlpha(fig, fstrm, StoredColors)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function print2eps(name, fig, export_options, varargin)</a>
0002 <span class="comment">%PRINT2EPS  Prints figures to eps with improved line styles</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Examples:</span>
0005 <span class="comment">%   print2eps filename</span>
0006 <span class="comment">%   print2eps(filename, fig_handle)</span>
0007 <span class="comment">%   print2eps(filename, fig_handle, export_options)</span>
0008 <span class="comment">%   print2eps(filename, fig_handle, export_options, print_options)</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% This function saves a figure as an eps file, with two improvements over</span>
0011 <span class="comment">% MATLAB's print command. First, it improves the line style, making dashed</span>
0012 <span class="comment">% lines more like those on screen and giving grid lines a dotted line style.</span>
0013 <span class="comment">% Secondly, it substitutes original font names back into the eps file,</span>
0014 <span class="comment">% where these have been changed by MATLAB, for up to 11 different fonts.</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%IN:</span>
0017 <span class="comment">%   filename - string containing the name (optionally including full or</span>
0018 <span class="comment">%              relative path) of the file the figure is to be saved as. A</span>
0019 <span class="comment">%              &quot;.eps&quot; extension is added if not there already. If a path is</span>
0020 <span class="comment">%              not specified, the figure is saved in the current directory.</span>
0021 <span class="comment">%   fig_handle - The handle of the figure to be saved. Default: gcf().</span>
0022 <span class="comment">%   export_options - array or struct of optional scalar values:</span>
0023 <span class="comment">%       bb_padding - Scalar value of amount of padding to add to border around</span>
0024 <span class="comment">%                    the cropped image, in points (if &gt;1) or percent (if &lt;1).</span>
0025 <span class="comment">%                    Can be negative as well as positive; Default: 0</span>
0026 <span class="comment">%       crop       - Cropping flag. Deafult: 0</span>
0027 <span class="comment">%       fontswap   - Whether to swap non-default fonts in figure. Default: true</span>
0028 <span class="comment">%       font_space - Character used to separate font-name terms in the EPS output</span>
0029 <span class="comment">%                    e.g. &quot;Courier New&quot; =&gt; &quot;Courier-New&quot;. Default: ''</span>
0030 <span class="comment">%                    (available only via the struct alternative)</span>
0031 <span class="comment">%       renderer   - Renderer used to generate bounding-box. Default: 'opengl'</span>
0032 <span class="comment">%                    (available only via the struct alternative)</span>
0033 <span class="comment">%       crop_amounts - 4-element vector of crop amounts: [top,right,bottom,left]</span>
0034 <span class="comment">%                    (available only via the struct alternative)</span>
0035 <span class="comment">%   print_options - Additional parameter strings to be passed to the print command</span>
0036 
0037 <span class="comment">%{</span>
0038 <span class="comment">% Copyright (C) Oliver Woodford 2008-2014, Yair Altman 2015-</span>
0039 
0040 <span class="comment">% The idea of editing the EPS file to change line styles comes from Jiro</span>
0041 <span class="comment">% Doke's FIXPSLINESTYLE (fex id: 17928)</span>
0042 <span class="comment">% The idea of changing dash length with line width came from comments on</span>
0043 <span class="comment">% fex id: 5743, but the implementation is mine :)</span>
0044 <span class="comment">%}</span>
0045 <span class="comment">%{</span>
0046 <span class="comment">% 14/11/11: Fix a MATLAB bug rendering black or white text incorrectly.</span>
0047 <span class="comment">%           Thanks to Mathieu Morlighem for reporting the issue and</span>
0048 <span class="comment">%           obtaining a fix from TMW.</span>
0049 <span class="comment">% 08/12/11: Added ability to correct fonts. Several people have requested</span>
0050 <span class="comment">%           this at one time or another, and also pointed me to printeps</span>
0051 <span class="comment">%           (fex id: 7501), so thank you to them. My implementation (which</span>
0052 <span class="comment">%           was not inspired by printeps - I'd already had the idea for my</span>
0053 <span class="comment">%           approach) goes slightly further in that it allows multiple</span>
0054 <span class="comment">%           fonts to be swapped.</span>
0055 <span class="comment">% 14/12/11: Fix bug affecting font names containing spaces. Thanks to David</span>
0056 <span class="comment">%           Szwer for reporting the issue.</span>
0057 <span class="comment">% 25/01/12: Add a font not to be swapped. Thanks to Anna Rafferty and Adam</span>
0058 <span class="comment">%           Jackson for reporting the issue. Also fix a bug whereby using a</span>
0059 <span class="comment">%           font alias can lead to another font being swapped in.</span>
0060 <span class="comment">% 10/04/12: Make the font swapping case insensitive.</span>
0061 <span class="comment">% 26/10/12: Set PaperOrientation to portrait. Thanks to Michael Watts for</span>
0062 <span class="comment">%           reporting the issue.</span>
0063 <span class="comment">% 26/10/12: Fix issue to do with swapping fonts changing other fonts and</span>
0064 <span class="comment">%           sizes we don't want, due to listeners. Thanks to Malcolm Hudson</span>
0065 <span class="comment">%           for reporting the issue.</span>
0066 <span class="comment">% 22/03/13: Extend font swapping to axes labels. Thanks to Rasmus Ischebeck</span>
0067 <span class="comment">%           for reporting the issue.</span>
0068 <span class="comment">% 23/07/13: Bug fix to font swapping. Thanks to George for reporting the</span>
0069 <span class="comment">%           issue.</span>
0070 <span class="comment">% 13/08/13: Fix MATLAB feature of not exporting white lines correctly.</span>
0071 <span class="comment">%           Thanks to Sebastian Hesslinger for reporting it.</span>
0072 <span class="comment">% 24/02/15: Fix for Matlab R2014b bug (issue #31): LineWidths&lt;0.75 are not</span>
0073 <span class="comment">%           set in the EPS (default line width is used)</span>
0074 <span class="comment">% 25/02/15: Fixed issue #32: BoundingBox problem caused uncropped EPS/PDF files</span>
0075 <span class="comment">% 05/03/15: Fixed issue #43: Inability to perform EPS file post-processing</span>
0076 <span class="comment">% 06/03/15: Improved image padding &amp; cropping thanks to Oscar Hartogensis</span>
0077 <span class="comment">% 21/03/15: Fixed edge-case of missing handles having a 'FontName' property</span>
0078 <span class="comment">% 26/03/15: Attempt to fix issue #45: white lines in subplots do not print correctly</span>
0079 <span class="comment">% 27/03/15: Attempt to fix issue #44: white artifact lines appearing in patch exports</span>
0080 <span class="comment">% 30/03/15: Fixed issue #52: improved performance on HG2 (R2014b+)</span>
0081 <span class="comment">% 09/04/15: Comment blocks consolidation and minor code cleanup (no real code change)</span>
0082 <span class="comment">% 12/04/15: Fixed issue #56: bad cropping</span>
0083 <span class="comment">% 14/04/15: Workaround for issue #45: lines in image subplots are exported in invalid color</span>
0084 <span class="comment">% 07/07/15: Added option to avoid font-swapping in EPS/PDF</span>
0085 <span class="comment">% 07/07/15: Fixed issue #83: use numeric handles in HG1</span>
0086 <span class="comment">% 22/07/15: Fixed issue #91 (thanks to Carlos Moffat)</span>
0087 <span class="comment">% 28/09/15: Fixed issue #108 (thanks to JacobD10)</span>
0088 <span class="comment">% 01/11/15: Fixed issue #112: optional renderer for bounding-box computation (thanks to Jesï¿½s Pestana Puerta)</span>
0089 <span class="comment">% 21/02/16: Enabled specifying non-automated crop amounts</span>
0090 <span class="comment">% 22/02/16: Better support + backward compatibility for transparency (issue #108)</span>
0091 <span class="comment">% 10/06/16: Fixed issue #159: text handles get cleared by Matlab in the print() command</span>
0092 <span class="comment">% 12/06/16: Improved the fix for issue #159 (in the previous commit)</span>
0093 <span class="comment">% 12/06/16: Fixed issue #158: transparent patch color in PDF/EPS</span>
0094 <span class="comment">% 18/09/17: Fixed issue #194: incorrect fonts in EPS/PDF output</span>
0095 <span class="comment">% 18/09/17: Fixed issue #195: relaxed too-tight cropping in EPS/PDF</span>
0096 <span class="comment">% 14/11/17: Workaround for issue #211: dashed/dotted lines in 3D axes appear solid</span>
0097 <span class="comment">% 15/11/17: Updated issue #211: only set SortMethod='ChildOrder' in HG2, and when it looks the same onscreen; support multiple figure axes</span>
0098 <span class="comment">% 18/11/17: Fixed issue #225: transparent/translucent dashed/dotted lines appear solid in EPS/PDF</span>
0099 <span class="comment">% 24/03/18: Fixed issue #239: black title meshes with temporary black background figure bgcolor, causing bad cropping</span>
0100 <span class="comment">%}</span>
0101 
0102     options = {<span class="string">'-loose'</span>};
0103     <span class="keyword">if</span> nargin &gt; 3
0104         options = [options varargin];
0105     <span class="keyword">elseif</span> nargin &lt; 3
0106         export_options = 0;
0107         <span class="keyword">if</span> nargin &lt; 2
0108             fig = gcf();
0109         <span class="keyword">end</span>
0110     <span class="keyword">end</span>
0111 
0112     <span class="comment">% Retrieve padding, crop &amp; font-swap values</span>
0113     crop_amounts = nan(1,4);  <span class="comment">% auto-crop all 4 sides by default</span>
0114     <span class="keyword">if</span> isstruct(export_options)
0115         <span class="keyword">try</span> fontswap     = export_options.fontswap;     <span class="keyword">catch</span>, fontswap = true;     <span class="keyword">end</span>
0116         <span class="keyword">try</span> font_space   = export_options.font_space;   <span class="keyword">catch</span>, font_space = <span class="string">''</span>;     <span class="keyword">end</span>
0117         font_space(2:end) = <span class="string">''</span>;
0118         <span class="keyword">try</span> bb_crop      = export_options.crop;         <span class="keyword">catch</span>, bb_crop = 0;         <span class="keyword">end</span>
0119         <span class="keyword">try</span> crop_amounts = export_options.crop_amounts; <span class="keyword">catch</span>,                      <span class="keyword">end</span>
0120         <span class="keyword">try</span> bb_padding   = export_options.bb_padding;   <span class="keyword">catch</span>, bb_padding = 0;      <span class="keyword">end</span>
0121         <span class="keyword">try</span> renderer     = export_options.rendererStr;  <span class="keyword">catch</span>, renderer = <span class="string">'opengl'</span>; <span class="keyword">end</span>  <span class="comment">% fix for issue #110</span>
0122         <span class="keyword">if</span> renderer(1)~=<span class="string">'-'</span>,  renderer = [<span class="string">'-'</span> renderer];  <span class="keyword">end</span>
0123     <span class="keyword">else</span>
0124         <span class="keyword">if</span> numel(export_options) &gt; 2  <span class="comment">% font-swapping</span>
0125             fontswap = export_options(3);
0126         <span class="keyword">else</span>
0127             fontswap = true;
0128         <span class="keyword">end</span>
0129         <span class="keyword">if</span> numel(export_options) &gt; 1  <span class="comment">% cropping</span>
0130             bb_crop = export_options(2);
0131         <span class="keyword">else</span>
0132             bb_crop = 0;  <span class="comment">% scalar value, so use default bb_crop value of 0</span>
0133         <span class="keyword">end</span>
0134         <span class="keyword">if</span> numel(export_options) &gt; 0  <span class="comment">% padding</span>
0135             bb_padding = export_options(1);
0136         <span class="keyword">else</span>
0137             bb_padding = 0;
0138         <span class="keyword">end</span>
0139         renderer = <span class="string">'-opengl'</span>;
0140         font_space = <span class="string">''</span>;
0141     <span class="keyword">end</span>
0142 
0143     <span class="comment">% Construct the filename</span>
0144     <span class="keyword">if</span> numel(name) &lt; 5 || ~strcmpi(name(end-3:end), <span class="string">'.eps'</span>)
0145         name = [name <span class="string">'.eps'</span>]; <span class="comment">% Add the missing extension</span>
0146     <span class="keyword">end</span>
0147 
0148     <span class="comment">% Set paper size</span>
0149     old_pos_mode = get(fig, <span class="string">'PaperPositionMode'</span>);
0150     old_orientation = get(fig, <span class="string">'PaperOrientation'</span>);
0151     set(fig, <span class="string">'PaperPositionMode'</span>, <span class="string">'auto'</span>, <span class="string">'PaperOrientation'</span>, <span class="string">'portrait'</span>);
0152 
0153     <span class="comment">% Find all the used fonts in the figure</span>
0154     font_handles = findall(fig, <span class="string">'-property'</span>, <span class="string">'FontName'</span>);
0155     fonts = get(font_handles, <span class="string">'FontName'</span>);
0156     <span class="keyword">if</span> isempty(fonts)
0157         fonts = {};
0158     <span class="keyword">elseif</span> ~iscell(fonts)
0159         fonts = {fonts};
0160     <span class="keyword">end</span>
0161 
0162     <span class="comment">% Map supported font aliases onto the correct name</span>
0163     fontsl = lower(fonts);
0164     <span class="keyword">for</span> a = 1:numel(fonts)
0165         f = fontsl{a};
0166         f(f==<span class="string">' '</span>) = [];
0167         <span class="keyword">switch</span> f
0168             <span class="keyword">case</span> {<span class="string">'times'</span>, <span class="string">'timesnewroman'</span>, <span class="string">'times-roman'</span>}
0169                 fontsl{a} = <span class="string">'times-roman'</span>;
0170             <span class="keyword">case</span> {<span class="string">'arial'</span>, <span class="string">'helvetica'</span>}
0171                 fontsl{a} = <span class="string">'helvetica'</span>;
0172             <span class="keyword">case</span> {<span class="string">'newcenturyschoolbook'</span>, <span class="string">'newcenturyschlbk'</span>}
0173                 fontsl{a} = <span class="string">'newcenturyschlbk'</span>;
0174             <span class="keyword">otherwise</span>
0175         <span class="keyword">end</span>
0176     <span class="keyword">end</span>
0177     fontslu = unique(fontsl);
0178 
0179     <span class="comment">% Determine the font swap table</span>
0180     <span class="keyword">if</span> fontswap
0181         matlab_fonts = {<span class="string">'Helvetica'</span>, <span class="string">'Times-Roman'</span>, <span class="string">'Palatino'</span>, <span class="string">'Bookman'</span>, <span class="string">'Helvetica-Narrow'</span>, <span class="string">'Symbol'</span>, <span class="keyword">...</span>
0182                         <span class="string">'AvantGarde'</span>, <span class="string">'NewCenturySchlbk'</span>, <span class="string">'Courier'</span>, <span class="string">'ZapfChancery'</span>, <span class="string">'ZapfDingbats'</span>};
0183         matlab_fontsl = lower(matlab_fonts);
0184         require_swap = find(~ismember(fontslu, matlab_fontsl));
0185         unused_fonts = find(~ismember(matlab_fontsl, fontslu));
0186         font_swap = cell(3, min(numel(require_swap), numel(unused_fonts)));
0187         fonts_new = fonts;
0188         <span class="keyword">for</span> a = 1:size(font_swap, 2)
0189             font_swap{1,a} = find(strcmp(fontslu{require_swap(a)}, fontsl));
0190             font_swap{2,a} = matlab_fonts{unused_fonts(a)};
0191             font_swap{3,a} = fonts{font_swap{1,a}(1)};
0192             fonts_new(font_swap{1,a}) = font_swap(2,a);
0193         <span class="keyword">end</span>
0194     <span class="keyword">else</span>
0195         font_swap = [];
0196     <span class="keyword">end</span>
0197 
0198     <span class="comment">% Swap the fonts</span>
0199     <span class="keyword">if</span> ~isempty(font_swap)
0200         fonts_size = get(font_handles, <span class="string">'FontSize'</span>);
0201         <span class="keyword">if</span> iscell(fonts_size)
0202             fonts_size = cell2mat(fonts_size);
0203         <span class="keyword">end</span>
0204         M = false(size(font_handles));
0205 
0206         <span class="comment">% Loop because some changes may not stick first time, due to listeners</span>
0207         c = 0;
0208         update = zeros(1000, 1);
0209         <span class="keyword">for</span> b = 1:10 <span class="comment">% Limit number of loops to avoid infinite loop case</span>
0210             <span class="keyword">for</span> a = 1:numel(M)
0211                 M(a) = ~isequal(get(font_handles(a), <span class="string">'FontName'</span>), fonts_new{a}) || ~isequal(get(font_handles(a), <span class="string">'FontSize'</span>), fonts_size(a));
0212                 <span class="keyword">if</span> M(a)
0213                     set(font_handles(a), <span class="string">'FontName'</span>, fonts_new{a}, <span class="string">'FontSize'</span>, fonts_size(a));
0214                     c = c + 1;
0215                     update(c) = a;
0216                 <span class="keyword">end</span>
0217             <span class="keyword">end</span>
0218             <span class="keyword">if</span> ~any(M)
0219                 <span class="keyword">break</span>;
0220             <span class="keyword">end</span>
0221         <span class="keyword">end</span>
0222 
0223         <span class="comment">% Compute the order to revert fonts later, without the need of a loop</span>
0224         [update, M] = unique(update(1:c));
0225         [dummy, M] = sort(M); <span class="comment">%#ok&lt;ASGLU&gt;</span>
0226         update = reshape(update(M), 1, []);
0227     <span class="keyword">end</span>
0228 
0229     <span class="comment">% MATLAB bug fix - black and white text can come out inverted sometimes</span>
0230     <span class="comment">% Find the white and black text</span>
0231     black_text_handles = findall(fig, <span class="string">'Type'</span>, <span class="string">'text'</span>, <span class="string">'Color'</span>, [0 0 0]);
0232     white_text_handles = findall(fig, <span class="string">'Type'</span>, <span class="string">'text'</span>, <span class="string">'Color'</span>, [1 1 1]);
0233     <span class="comment">% Set the font colors slightly off their correct values</span>
0234     set(black_text_handles, <span class="string">'Color'</span>, [0 0 0] + eps);
0235     set(white_text_handles, <span class="string">'Color'</span>, [1 1 1] - eps);
0236 
0237     <span class="comment">% MATLAB bug fix - white lines can come out funny sometimes</span>
0238     <span class="comment">% Find the white lines</span>
0239     white_line_handles = findall(fig, <span class="string">'Type'</span>, <span class="string">'line'</span>, <span class="string">'Color'</span>, [1 1 1]);
0240     <span class="comment">% Set the line color slightly off white</span>
0241     set(white_line_handles, <span class="string">'Color'</span>, [1 1 1] - 0.00001);
0242 
0243     <span class="comment">% MATLAB bug fix (issue #211): dashed/dotted lines in 3D axes appear solid</span>
0244     <span class="comment">% Note: this &quot;may limit other functionality in plotting such as hidden line/surface removal&quot;</span>
0245     <span class="comment">% reference: Technical Support Case #02838114, https://mail.google.com/mail/u/0/#inbox/15fb7659f70e7bd8</span>
0246     hAxes = findall(fig, <span class="string">'Type'</span>, <span class="string">'axes'</span>);
0247     <span class="keyword">if</span> <a href="using_hg2.html" class="code" title="function tf = using_hg2(fig)">using_hg2</a> &amp;&amp; ~isempty(hAxes)  <span class="comment">% issue #211 presumably happens only in HG2, not HG1</span>
0248         <span class="keyword">try</span>
0249             <span class="comment">% If there are any axes using SortMethod~='ChildOrder'</span>
0250             oldSortMethods = get(hAxes,{<span class="string">'SortMethod'</span>});  <span class="comment">% use {'SortMethod'} to ensure we get a cell array, even for single axes</span>
0251             <span class="keyword">if</span> any(~strcmpi(<span class="string">'ChildOrder'</span>,oldSortMethods))  <span class="comment">% i.e., any oldSortMethods=='depth'</span>
0252                 <span class="comment">% Check if the axes look visually different onscreen when SortMethod='ChildOrder'</span>
0253                 imgBefore = <a href="print2array.html" class="code" title="function [A, bcol] = print2array(fig, res, renderer, gs_options)">print2array</a>(fig);
0254                 set(hAxes,<span class="string">'SortMethod'</span>,<span class="string">'ChildOrder'</span>);
0255                 imgAfter  = <a href="print2array.html" class="code" title="function [A, bcol] = print2array(fig, res, renderer, gs_options)">print2array</a>(fig);
0256                 <span class="keyword">if</span> isequal(imgBefore, imgAfter)
0257                     <span class="comment">% They look the same, so use SortMethod='ChildOrder' when generating the EPS</span>
0258                 <span class="keyword">else</span>
0259                     <span class="comment">% They look different, so revert SortMethod and issue a warning message</span>
0260                     warning(<span class="string">'YMA:export_fig:issue211'</span>, <span class="keyword">...</span>
0261                             [<span class="string">'You seem to be using axes that have overlapping/hidden graphic elements. '</span> 10 <span class="keyword">...</span>
0262                              <span class="string">'Setting axes.SortMethod=''ChildOrder'' may solve potential problems in EPS/PDF export. '</span> 10 <span class="keyword">...</span>
0263                              <span class="string">'Additional info: https://github.com/altmany/export_fig/issues/211'</span>])
0264                     set(hAxes,{<span class="string">'SortMethod'</span>},oldSortMethods);
0265                 <span class="keyword">end</span>
0266             <span class="keyword">end</span>
0267         <span class="keyword">catch</span> err
0268             <span class="comment">% ignore</span>
0269             a=err;  <span class="comment">%#ok&lt;NASGU&gt; % debug breakpoint</span>
0270         <span class="keyword">end</span>
0271     <span class="keyword">end</span>
0272 
0273     <span class="comment">% Workaround for issue #45: lines in image subplots are exported in invalid color</span>
0274     <span class="comment">% In this case the -depsc driver solves the problem, but then all the other workarounds</span>
0275     <span class="comment">% below (for all the other issues) will fail, so it's better to let the user decide by</span>
0276     <span class="comment">% just issuing a warning and accepting the '-depsc' input parameter</span>
0277     epsLevel2 = ~any(strcmpi(options,<span class="string">'-depsc'</span>));
0278     <span class="keyword">if</span> epsLevel2
0279         <span class="comment">% Use -depsc2 (EPS color level-2) if -depsc (EPS color level-3) was not specifically requested</span>
0280         options{end+1} = <span class="string">'-depsc2'</span>;
0281         <span class="comment">% Issue a warning if multiple images &amp; lines were found in the figure, and HG1 with painters renderer is used</span>
0282         isPainters = any(strcmpi(options,<span class="string">'-painters'</span>));
0283         <span class="keyword">if</span> isPainters &amp;&amp; ~<a href="using_hg2.html" class="code" title="function tf = using_hg2(fig)">using_hg2</a> &amp;&amp; numel(findall(fig,<span class="string">'Type'</span>,<span class="string">'image'</span>))&gt;1 &amp;&amp; ~isempty(findall(fig,<span class="string">'Type'</span>,<span class="string">'line'</span>))
0284             warning(<span class="string">'YMA:export_fig:issue45'</span>, <span class="keyword">...</span>
0285                     [<span class="string">'Multiple images &amp; lines detected. In such cases, the lines might \n'</span> <span class="keyword">...</span>
0286                      <span class="string">'appear with an invalid color due to an internal MATLAB bug (fixed in R2014b). \n'</span> <span class="keyword">...</span>
0287                      <span class="string">'Possible workaround: add a ''-depsc'' or ''-opengl'' parameter to the export_fig command.'</span>]);
0288         <span class="keyword">end</span>
0289     <span class="keyword">end</span>
0290 
0291     <span class="comment">% Fix issue #83: use numeric handles in HG1</span>
0292     <span class="keyword">if</span> ~<a href="using_hg2.html" class="code" title="function tf = using_hg2(fig)">using_hg2</a>(fig),  fig = double(fig);  <span class="keyword">end</span>
0293 
0294     <span class="comment">% Workaround for when transparency is lost through conversion fig&gt;EPS&gt;PDF (issue #108)</span>
0295     <span class="comment">% Replace transparent patch RGB values with an ID value (rare chance that ID color is being used already)</span>
0296     <span class="keyword">if</span> <a href="using_hg2.html" class="code" title="function tf = using_hg2(fig)">using_hg2</a>
0297         origAlphaColors = <a href="#_sub1" class="code" title="subfunction [StoredColors, fstrm, foundFlags] = eps_maintainAlpha(fig, fstrm, StoredColors)">eps_maintainAlpha</a>(fig);
0298     <span class="keyword">end</span>
0299 
0300     <span class="comment">% Print to eps file</span>
0301     print(fig, options{:}, name);
0302 
0303     <span class="comment">% Restore the original axes SortMethods (if updated)</span>
0304     <span class="keyword">try</span> set(hAxes,{<span class="string">'SortMethod'</span>},oldSortMethods); <span class="keyword">catch</span>, <span class="keyword">end</span>
0305 
0306     <span class="comment">% Do post-processing on the eps file</span>
0307     <span class="keyword">try</span>
0308         <span class="comment">% Read the EPS file into memory</span>
0309         fstrm = <a href="read_write_entire_textfile.html" class="code" title="function fstrm = read_write_entire_textfile(fname, fstrm)">read_write_entire_textfile</a>(name);
0310     <span class="keyword">catch</span>
0311         fstrm = <span class="string">''</span>;
0312     <span class="keyword">end</span>
0313 
0314     <span class="comment">% Restore colors for transparent patches/lines and apply the</span>
0315     <span class="comment">% setopacityalpha setting in the EPS file (issue #108)</span>
0316     <span class="keyword">if</span> <a href="using_hg2.html" class="code" title="function tf = using_hg2(fig)">using_hg2</a>
0317         [~,fstrm,foundFlags] = <a href="#_sub1" class="code" title="subfunction [StoredColors, fstrm, foundFlags] = eps_maintainAlpha(fig, fstrm, StoredColors)">eps_maintainAlpha</a>(fig, fstrm, origAlphaColors);
0318 
0319         <span class="comment">% If some of the transparencies were not found in the EPS file, then rerun the</span>
0320         <span class="comment">% export with only the found transparencies modified (backward compatibility)</span>
0321         <span class="keyword">if</span> ~isempty(fstrm) &amp;&amp; ~all(foundFlags)
0322             foundIdx = find(foundFlags);
0323             <span class="keyword">for</span> objIdx = 1 : sum(foundFlags)
0324                 colorsIdx = foundIdx(objIdx);
0325                 colorsData = origAlphaColors{colorsIdx};
0326                 hObj     = colorsData{1};
0327                 propName = colorsData{2};
0328                 newColor = colorsData{4};
0329                 hObj.(propName).ColorData = newColor;
0330             <span class="keyword">end</span>
0331             delete(name);
0332             print(fig, options{:}, name);
0333             fstrm = <a href="read_write_entire_textfile.html" class="code" title="function fstrm = read_write_entire_textfile(fname, fstrm)">read_write_entire_textfile</a>(name);
0334             [~,fstrm] = <a href="#_sub1" class="code" title="subfunction [StoredColors, fstrm, foundFlags] = eps_maintainAlpha(fig, fstrm, StoredColors)">eps_maintainAlpha</a>(fig, fstrm, origAlphaColors(foundFlags));
0335         <span class="keyword">end</span>
0336     <span class="keyword">end</span>
0337 
0338     <span class="comment">% Fix for Matlab R2014b bug (issue #31): LineWidths&lt;0.75 are not set in the EPS (default line width is used)</span>
0339     <span class="keyword">try</span>
0340         <span class="keyword">if</span> ~isempty(fstrm) &amp;&amp; <a href="using_hg2.html" class="code" title="function tf = using_hg2(fig)">using_hg2</a>(fig)
0341             <span class="comment">% Convert miter joins to line joins</span>
0342             <span class="comment">%fstrm = regexprep(fstrm, '\n10.0 ML\n', '\n1 LJ\n');</span>
0343             <span class="comment">% This is faster (the original regexprep could take many seconds when the axes contains many lines):</span>
0344             fstrm = strrep(fstrm, sprintf(<span class="string">'\n10.0 ML\n'</span>), sprintf(<span class="string">'\n1 LJ\n'</span>));
0345 
0346             <span class="comment">% In HG2, grid lines and axes Ruler Axles have a default LineWidth of 0.5 =&gt; replace en-bulk (assume that 1.0 LineWidth = 1.333 LW)</span>
0347             <span class="comment">%   hAxes=gca; hAxes.YGridHandle.LineWidth, hAxes.YRuler.Axle.LineWidth</span>
0348             <span class="comment">%fstrm = regexprep(fstrm, '(GC\n2 setlinecap\n1 LJ)\nN', '$1\n0.667 LW\nN');</span>
0349             <span class="comment">% This is faster:</span>
0350             fstrm = strrep(fstrm, sprintf(<span class="string">'GC\n2 setlinecap\n1 LJ\nN'</span>), sprintf(<span class="string">'GC\n2 setlinecap\n1 LJ\n0.667 LW\nN'</span>));
0351 
0352             <span class="comment">% This is more accurate but *MUCH* slower (issue #52)</span>
0353             <span class="comment">%{</span>
0354             <span class="comment">% Modify all thin lines in the figure to have 10x LineWidths</span>
0355             hLines = findall(fig,<span class="string">'Type'</span>,<span class="string">'line'</span>);
0356             hThinLines = [];
0357             <span class="keyword">for</span> lineIdx = 1 : numel(hLines)
0358                 thisLine = hLines(lineIdx);
0359                 <span class="keyword">if</span> thisLine.LineWidth &lt; 0.75 &amp;&amp; strcmpi(thisLine.Visible,<span class="string">'on'</span>)
0360                     hThinLines(end+1) = thisLine; <span class="comment">%#ok&lt;AGROW&gt;</span>
0361                     thisLine.LineWidth = thisLine.LineWidth * 10;
0362                 <span class="keyword">end</span>
0363             <span class="keyword">end</span>
0364 
0365             <span class="comment">% If any thin lines were found</span>
0366             <span class="keyword">if</span> ~isempty(hThinLines)
0367                 <span class="comment">% Prepare an EPS with large-enough line widths</span>
0368                 print(fig, options{:}, name);
0369                 <span class="comment">% Restore the original LineWidths in the figure</span>
0370                 <span class="keyword">for</span> lineIdx = 1 : numel(hThinLines)
0371                     thisLine = handle(hThinLines(lineIdx));
0372                     thisLine.LineWidth = thisLine.LineWidth / 10;
0373                 <span class="keyword">end</span>
0374 
0375                 <span class="comment">% Compare the original and the new EPS files and correct the original stream's LineWidths</span>
0376                 fstrm_new = <a href="read_write_entire_textfile.html" class="code" title="function fstrm = read_write_entire_textfile(fname, fstrm)">read_write_entire_textfile</a>(name);
0377                 idx = 500;  <span class="comment">% skip heading with its possibly-different timestamp</span>
0378                 markerStr = sprintf(<span class="string">'10.0 ML\nN'</span>);
0379                 markerLen = length(markerStr);
0380                 <span class="keyword">while</span> ~isempty(idx) &amp;&amp; idx &lt; length(fstrm)
0381                     lastIdx = min(length(fstrm), length(fstrm_new));
0382                     delta = fstrm(idx+1:lastIdx) - fstrm_new(idx+1:lastIdx);
0383                     idx = idx + find(delta,1);
0384                     <span class="keyword">if</span> ~isempty(idx) &amp;&amp; <span class="keyword">...</span>
0385                             isequal(fstrm(idx-markerLen+1:idx), markerStr) &amp;&amp; <span class="keyword">...</span>
0386                             ~isempty(regexp(fstrm_new(idx-markerLen+1:idx+12),<span class="string">'10.0 ML\n[\d\.]+ LW\nN'</span>)) <span class="comment">%#ok&lt;RGXP1&gt;</span>
0387                         value = str2double(regexprep(fstrm_new(idx:idx+12),<span class="string">' .*'</span>,<span class="string">''</span>));
0388                         <span class="keyword">if</span> isnan(value), <span class="keyword">break</span>; <span class="keyword">end</span>  <span class="comment">% something's wrong... - bail out</span>
0389                         newStr = sprintf(<span class="string">'%0.3f LW\n'</span>,value/10);
0390                         fstrm = [fstrm(1:idx-1) newStr fstrm(idx:end)];
0391                         idx = idx + 12;
0392                     <span class="keyword">else</span>
0393                         <span class="keyword">break</span>;
0394                     <span class="keyword">end</span>
0395                 <span class="keyword">end</span>
0396             <span class="keyword">end</span>
0397             <span class="comment">%}</span>
0398 
0399             <span class="comment">% This is much faster although less accurate: fix all non-gray lines to have a LineWidth of 0.75 (=1 LW)</span>
0400             <span class="comment">% Note: This will give incorrect LineWidth of 075 for lines having LineWidth&lt;0.75, as well as for non-gray grid-lines (if present)</span>
0401             <span class="comment">%       However, in practice these edge-cases are very rare indeed, and the difference in LineWidth should not be noticeable</span>
0402             <span class="comment">%fstrm = regexprep(fstrm, '([CR]C\n2 setlinecap\n1 LJ)\nN', '$1\n1 LW\nN');</span>
0403             <span class="comment">% This is faster (the original regexprep could take many seconds when the axes contains many lines):</span>
0404             fstrm = strrep(fstrm, sprintf(<span class="string">'\n2 setlinecap\n1 LJ\nN'</span>), sprintf(<span class="string">'\n2 setlinecap\n1 LJ\n1 LW\nN'</span>));
0405         <span class="keyword">end</span>
0406     <span class="keyword">catch</span> err
0407         fprintf(2, <span class="string">'Error fixing LineWidths in EPS file: %s\n at %s:%d\n'</span>, err.message, err.stack(1).file, err.stack(1).line);
0408     <span class="keyword">end</span>
0409 
0410     <span class="comment">% Reset the font and line colors</span>
0411     <span class="keyword">try</span>
0412         set(black_text_handles, <span class="string">'Color'</span>, [0 0 0]);
0413         set(white_text_handles, <span class="string">'Color'</span>, [1 1 1]);
0414     <span class="keyword">catch</span>
0415         <span class="comment">% Fix issue #159: redo findall() '*text_handles'</span>
0416         black_text_handles = findall(fig, <span class="string">'Type'</span>, <span class="string">'text'</span>, <span class="string">'Color'</span>, [0 0 0]+eps);
0417         white_text_handles = findall(fig, <span class="string">'Type'</span>, <span class="string">'text'</span>, <span class="string">'Color'</span>, [1 1 1]-eps);
0418         set(black_text_handles, <span class="string">'Color'</span>, [0 0 0]);
0419         set(white_text_handles, <span class="string">'Color'</span>, [1 1 1]);
0420     <span class="keyword">end</span>
0421     set(white_line_handles, <span class="string">'Color'</span>, [1 1 1]);
0422 
0423     <span class="comment">% Reset paper size</span>
0424     set(fig, <span class="string">'PaperPositionMode'</span>, old_pos_mode, <span class="string">'PaperOrientation'</span>, old_orientation);
0425 
0426     <span class="comment">% Reset the font names in the figure</span>
0427     <span class="keyword">if</span> ~isempty(font_swap)
0428         <span class="keyword">for</span> a = update
0429             set(font_handles(a), <span class="string">'FontName'</span>, fonts{a}, <span class="string">'FontSize'</span>, fonts_size(a));
0430         <span class="keyword">end</span>
0431     <span class="keyword">end</span>
0432 
0433     <span class="comment">% Bail out if EPS post-processing is not possible</span>
0434     <span class="keyword">if</span> isempty(fstrm)
0435         warning(<span class="string">'Loading EPS file failed, so unable to perform post-processing. This is usually because the figure contains a large number of patch objects. Consider exporting to a bitmap format in this case.'</span>);
0436         <span class="keyword">return</span>
0437     <span class="keyword">end</span>
0438 
0439     <span class="comment">% Replace the font names</span>
0440     <span class="keyword">if</span> ~isempty(font_swap)
0441         <span class="keyword">for</span> a = 1:size(font_swap, 2)
0442             fontName = font_swap{3,a};
0443             <span class="comment">%fontName = fontName(~isspace(font_swap{3,a}));</span>
0444             <span class="keyword">if</span> length(fontName) &gt; 29
0445                 warning(<span class="string">'YMA:export_fig:font_name'</span>,<span class="string">'Font name ''%s'' is longer than 29 characters. This might cause problems in some EPS/PDF readers. Consider using a different font.'</span>,fontName);
0446             <span class="keyword">end</span>
0447             <span class="keyword">if</span> isempty(font_space)
0448                 fontName(fontName==<span class="string">' '</span>) = <span class="string">''</span>;
0449             <span class="keyword">else</span>
0450                 fontName(fontName==<span class="string">' '</span>) = char(font_space);
0451             <span class="keyword">end</span>
0452             <span class="comment">%fstrm = regexprep(fstrm, [font_swap{1,a} '-?[a-zA-Z]*\&gt;'], fontName);</span>
0453             fstrm = regexprep(fstrm, font_swap{2,a}, fontName);
0454         <span class="keyword">end</span>
0455     <span class="keyword">end</span>
0456 
0457     <span class="comment">% Move the bounding box to the top of the file (HG2 only), or fix the line styles (HG1 only)</span>
0458     <span class="keyword">if</span> <a href="using_hg2.html" class="code" title="function tf = using_hg2(fig)">using_hg2</a>(fig)
0459         <span class="comment">% Move the bounding box to the top of the file (HG2 only)</span>
0460         [s, e] = regexp(fstrm, <span class="string">'%%BoundingBox: [^%]*%%'</span>);
0461         <span class="keyword">if</span> numel(s) == 2
0462             fstrm = fstrm([1:s(1)-1 s(2):e(2)-2 e(1)-1:s(2)-1 e(2)-1:end]);
0463         <span class="keyword">end</span>
0464     <span class="keyword">else</span>
0465         <span class="comment">% Fix the line styles (HG1 only)</span>
0466         fstrm = <a href="fix_lines.html" class="code" title="function fstrm = fix_lines(fstrm, fname2)">fix_lines</a>(fstrm);
0467     <span class="keyword">end</span>
0468 
0469     <span class="comment">% Apply the bounding box padding &amp; cropping, replacing Matlab's print()'s bounding box</span>
0470     <span class="keyword">if</span> bb_crop
0471         <span class="comment">% Calculate a new bounding box based on a bitmap print using crop_border.m</span>
0472         <span class="comment">% 1. Determine the Matlab BoundingBox and PageBoundingBox</span>
0473         [s,e] = regexp(fstrm, <span class="string">'%%BoundingBox: [^%]*%%'</span>); <span class="comment">% location BB in eps file</span>
0474         <span class="keyword">if</span> numel(s)==2, s=s(2); e=e(2); <span class="keyword">end</span>
0475         aa = fstrm(s+15:e-3); <span class="comment">% dimensions bb - STEP1</span>
0476         bb_matlab = cell2mat(textscan(aa,<span class="string">'%f32%f32%f32%f32'</span>));  <span class="comment">% dimensions bb - STEP2</span>
0477 
0478         [s,e] = regexp(fstrm, <span class="string">'%%PageBoundingBox: [^%]*%%'</span>); <span class="comment">% location bb in eps file</span>
0479         <span class="keyword">if</span> numel(s)==2, s=s(2); e=e(2); <span class="keyword">end</span>
0480         aa = fstrm(s+19:e-3); <span class="comment">% dimensions bb - STEP1</span>
0481         pagebb_matlab = cell2mat(textscan(aa,<span class="string">'%f32%f32%f32%f32'</span>));  <span class="comment">% dimensions bb - STEP2</span>
0482 
0483         <span class="comment">% 1b. Fix issue #239: black title meshes with temporary black background figure bgcolor, causing bad cropping</span>
0484         hTitles = [];
0485         <span class="keyword">if</span> isequal(get(fig,<span class="string">'Color'</span>),<span class="string">'none'</span>)
0486             hAxes = findall(fig,<span class="string">'type'</span>,<span class="string">'axes'</span>);
0487             <span class="keyword">for</span> idx = 1 : numel(hAxes)
0488                 hAx = hAxes(idx);
0489                 <span class="keyword">try</span>
0490                     hTitle = hAx.Title;
0491                     oldColor = hTitle.Color;
0492                     <span class="keyword">if</span> all(oldColor &lt; 5*eps) || (ischar(oldColor) &amp;&amp; lower(oldColor(1))==<span class="string">'k'</span>)
0493                         hTitles(end+1) = hTitle; <span class="comment">%#ok&lt;AGROW&gt;</span>
0494                         hTitle.Color = [0,0,.01];
0495                     <span class="keyword">end</span>
0496                 <span class="keyword">catch</span>
0497                 <span class="keyword">end</span>
0498             <span class="keyword">end</span>
0499         <span class="keyword">end</span>
0500 
0501         <span class="comment">% 2. Create a bitmap image and use crop_borders to create the relative</span>
0502         <span class="comment">%    bb with respect to the PageBoundingBox</span>
0503         [A, bcol] = <a href="print2array.html" class="code" title="function [A, bcol] = print2array(fig, res, renderer, gs_options)">print2array</a>(fig, 1, renderer);
0504         [aa, aa, aa, bb_rel] = <a href="crop_borders.html" class="code" title="function [A, vA, vB, bb_rel] = crop_borders(A, bcol, padding, crop_amounts)">crop_borders</a>(A, bcol, bb_padding, crop_amounts); <span class="comment">%#ok&lt;ASGLU&gt;</span>
0505 
0506         <span class="keyword">try</span> set(hTitles,<span class="string">'Color'</span>,<span class="string">'k'</span>); <span class="keyword">catch</span>, <span class="keyword">end</span>
0507 
0508         <span class="comment">% 3. Calculate the new Bounding Box</span>
0509         pagew = pagebb_matlab(3)-pagebb_matlab(1);
0510         pageh = pagebb_matlab(4)-pagebb_matlab(2);
0511         <span class="comment">%bb_new = [pagebb_matlab(1)+pagew*bb_rel(1) pagebb_matlab(2)+pageh*bb_rel(2) ...</span>
0512         <span class="comment">%          pagebb_matlab(1)+pagew*bb_rel(3) pagebb_matlab(2)+pageh*bb_rel(4)];</span>
0513         bb_new = pagebb_matlab([1,2,1,2]) + [pagew,pageh,pagew,pageh].*bb_rel;  <span class="comment">% clearer</span>
0514         bb_offset = (bb_new-bb_matlab) + [-2,-2,2,2];  <span class="comment">% 2px margin so that cropping is not TOO tight (issue #195)</span>
0515 
0516         <span class="comment">% Apply the bounding box padding</span>
0517         <span class="keyword">if</span> bb_padding
0518             <span class="keyword">if</span> abs(bb_padding)&lt;1
0519                 bb_padding = round((mean([bb_new(3)-bb_new(1) bb_new(4)-bb_new(2)])*bb_padding)/0.5)*0.5; <span class="comment">% ADJUST BB_PADDING</span>
0520             <span class="keyword">end</span>
0521             add_padding = @(n1, n2, n3, n4) sprintf(<span class="string">' %.0f'</span>, str2double({n1, n2, n3, n4}) + bb_offset + bb_padding*[-1,-1,1,1]); <span class="comment">%#ok&lt;NASGU&gt;</span>
0522         <span class="keyword">else</span>
0523             add_padding = @(n1, n2, n3, n4) sprintf(<span class="string">' %.0f'</span>, str2double({n1, n2, n3, n4}) + bb_offset); <span class="comment">%#ok&lt;NASGU&gt; % fix small but noticeable bounding box shift</span>
0524         <span class="keyword">end</span>
0525         fstrm = regexprep(fstrm, <span class="string">'%%BoundingBox:[ ]+([-]?\d+)[ ]+([-]?\d+)[ ]+([-]?\d+)[ ]+([-]?\d+)'</span>, <span class="string">'%%BoundingBox:${add_padding($1, $2, $3, $4)}'</span>);
0526     <span class="keyword">end</span>
0527 
0528     <span class="comment">% Fix issue #44: white artifact lines appearing in patch exports</span>
0529     <span class="comment">% Note: the problem is due to the fact that Matlab's print() function exports patches</span>
0530     <span class="comment">%       as a combination of filled triangles, and a white line appears where the triangles touch</span>
0531     <span class="comment">% In the workaround below, we will modify such dual-triangles into a filled rectangle.</span>
0532     <span class="comment">% We are careful to only modify regexps that exactly match specific patterns - it's better to not</span>
0533     <span class="comment">% correct some white-line artifacts than to change the geometry of a patch, or to corrupt the EPS.</span>
0534     <span class="comment">%   e.g.: '0 -450 937 0 0 450 3 MP PP 937 0 0 -450 0 450 3 MP PP' =&gt; '0 -450 937 0 0 450 0 0 4 MP'</span>
0535     fstrm = regexprep(fstrm, <span class="string">'\n([-\d.]+ [-\d.]+) ([-\d.]+ [-\d.]+) ([-\d.]+ [-\d.]+) 3 MP\nPP\n\2 \1 \3 3 MP\nPP\n'</span>,<span class="string">'\n$1 $2 $3 0 0 4 MP\nPP\n'</span>);
0536     fstrm = regexprep(fstrm, <span class="string">'\n([-\d.]+ [-\d.]+) ([-\d.]+ [-\d.]+) ([-\d.]+ [-\d.]+) 3 MP\nPP\n\2 \3 \1 3 MP\nPP\n'</span>,<span class="string">'\n$1 $2 $3 0 0 4 MP\nPP\n'</span>);
0537     fstrm = regexprep(fstrm, <span class="string">'\n([-\d.]+ [-\d.]+) ([-\d.]+ [-\d.]+) ([-\d.]+ [-\d.]+) 3 MP\nPP\n\3 \1 \2 3 MP\nPP\n'</span>,<span class="string">'\n$1 $2 $3 0 0 4 MP\nPP\n'</span>);
0538     fstrm = regexprep(fstrm, <span class="string">'\n([-\d.]+ [-\d.]+) ([-\d.]+ [-\d.]+) ([-\d.]+ [-\d.]+) 3 MP\nPP\n\3 \2 \1 3 MP\nPP\n'</span>,<span class="string">'\n$1 $2 $3 0 0 4 MP\nPP\n'</span>);
0539 
0540     <span class="comment">% Write out the fixed eps file</span>
0541     <a href="read_write_entire_textfile.html" class="code" title="function fstrm = read_write_entire_textfile(fname, fstrm)">read_write_entire_textfile</a>(name, fstrm);
0542 <span class="keyword">end</span>
0543 
0544 <a name="_sub1" href="#_subfunctions" class="code">function [StoredColors, fstrm, foundFlags] = eps_maintainAlpha(fig, fstrm, StoredColors)</a>
0545     <span class="keyword">if</span> nargin == 1  <span class="comment">% in: convert transparency in Matlab figure into unique RGB colors</span>
0546         hObjs = findall(fig); <span class="comment">%findobj(fig,'Type','Area');</span>
0547         StoredColors = {};
0548         propNames = {<span class="string">'Face'</span>,<span class="string">'Edge'</span>};
0549         <span class="keyword">for</span> objIdx = 1:length(hObjs)
0550             hObj = hObjs(objIdx);
0551             <span class="keyword">for</span> propIdx = 1 : numel(propNames)
0552                 <span class="keyword">try</span>
0553                     propName = propNames{propIdx};
0554                     <span class="keyword">if</span> strcmp(hObj.(propName).ColorType, <span class="string">'truecoloralpha'</span>)
0555                         nColors = length(StoredColors);
0556                         oldColor = hObj.(propName).ColorData;
0557                         newColor = uint8([101; 102+floor(nColors/255); mod(nColors,255); 255]);
0558                         StoredColors{end+1} = {hObj, propName, oldColor, newColor}; <span class="comment">%#ok&lt;AGROW&gt;</span>
0559                         hObj.(propName).ColorData = newColor;
0560                     <span class="keyword">end</span>
0561                 <span class="keyword">catch</span>
0562                     <span class="comment">% Never mind - ignore (either doesn't have the property or cannot change it)</span>
0563                 <span class="keyword">end</span>
0564             <span class="keyword">end</span>
0565         <span class="keyword">end</span>
0566     <span class="keyword">else</span>  <span class="comment">% restore transparency in Matlab figure by converting back from the unique RGBs</span>
0567         <span class="comment">%Find the transparent patches</span>
0568         wasError = false;
0569         nColors = length(StoredColors);
0570         foundFlags = false(1,nColors);
0571         <span class="keyword">for</span> objIdx = 1 : nColors
0572             colorsData = StoredColors{objIdx};
0573             hObj      = colorsData{1};
0574             propName  = colorsData{2};
0575             origColor = colorsData{3};
0576             newColor  = colorsData{4};
0577             <span class="keyword">try</span>
0578                 <span class="comment">%Restore the EPS files patch color</span>
0579                 colorID   = num2str(round(double(newColor(1:3)') /255,3),<span class="string">'%.3g %.3g %.3g'</span>); <span class="comment">%ID for searching</span>
0580                 origRGB   = num2str(round(double(origColor(1:3)')/255,3),<span class="string">'%.3g %.3g %.3g'</span>); <span class="comment">%Replace with original color</span>
0581                 origAlpha = num2str(round(double(origColor(end)) /255,3),<span class="string">'%.3g'</span>); <span class="comment">%Convert alpha value for EPS</span>
0582 
0583                 <span class="comment">%Find and replace the RGBA values within the EPS text fstrm</span>
0584                 <span class="keyword">if</span> strcmpi(propName,<span class="string">'Face'</span>)
0585                     oldStr = sprintf([<span class="string">'\n'</span> colorID <span class="string">' RC\n'</span>]);  <span class="comment">% ...N\n (removed to fix issue #225)</span>
0586                     newStr = sprintf([<span class="string">'\n'</span> origRGB <span class="string">' RC\n'</span> origAlpha <span class="string">' .setopacityalpha true\n'</span>]);  <span class="comment">% ...N\n</span>
0587                 <span class="keyword">else</span>  <span class="comment">%'Edge'</span>
0588                     oldStr = sprintf([<span class="string">'\n'</span> colorID <span class="string">' RC\n'</span>]);  <span class="comment">% ...1 LJ\n (removed to fix issue #225)</span>
0589                     newStr = sprintf([<span class="string">'\n'</span> origRGB <span class="string">' RC\n'</span> origAlpha <span class="string">' .setopacityalpha true\n'</span>]);
0590                 <span class="keyword">end</span>
0591                 foundFlags(objIdx) = ~isempty(strfind(fstrm, oldStr)); <span class="comment">%#ok&lt;STREMP&gt;</span>
0592                 fstrm = strrep(fstrm, oldStr, newStr);
0593 
0594                 <span class="comment">%Restore the figure object's original color</span>
0595                 hObj.(propName).ColorData = origColor;
0596             <span class="keyword">catch</span> err
0597                 <span class="comment">% something is wrong - cannot restore transparent color...</span>
0598                 <span class="keyword">if</span> ~wasError
0599                     fprintf(2, <span class="string">'Error maintaining transparency in EPS file: %s\n at %s:%d\n'</span>, err.message, err.stack(1).file, err.stack(1).line);
0600                     wasError = true;
0601                 <span class="keyword">end</span>
0602             <span class="keyword">end</span>
0603         <span class="keyword">end</span>
0604     <span class="keyword">end</span>
0605 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Wed 28-Apr-2021 14:02:00 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>