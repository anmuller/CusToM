<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of MVNXInverseKinematics</title>
  <meta name="keywords" content="MVNXInverseKinematics">
  <meta name="description" content="Recovery of joint coordinates in a MVNX file">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html Functions --><!-- menu.html XSens -->
<h1>MVNXInverseKinematics
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Recovery of joint coordinates in a MVNX file</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function MVNXInverseKinematics(filename, AnalysisParameters) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Recovery of joint coordinates in a MVNX file

   INPUT
   - filename: name of the file to process (character string)
   - AnalysisParameters: parameters of the musculoskeletal analysis,
   automatically generated by the graphic interface 'Analysis' 
   OUTPUT
   Results are automatically saved on the folder associated to each motion
   capture in variables 'ExperimentalData' and 'InverseKinematicsResults'.
________________________________________________________

 Licence
 Toolbox distributed under GPL 3.0 Licence
________________________________________________________

 Authors : Antoine Muller, Charles Pontonnier, Pierre Puchaud and
 Georges Dumont
________________________________________________________</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../Functions/AlgoMathsModel/filt_data.html" class="code" title="function [data]=filt_data(data,f,f_mocap)">filt_data</a>	4-th order Butterworth low pass filter with no phase shift</li><li><a href="../../Functions/ExternLibrary/XSens/load_mvnx.html" class="code" title="function mvnx = load_mvnx(filename)">load_mvnx</a>	mvnx = load_mvnx(filename)</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../Functions/Kinematics/InverseKinematics.html" class="code" title="function [] = InverseKinematics(AnalysisParameters,varargin)">InverseKinematics</a>	Computation of the inverse kinematics step</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function MVNXInverseKinematics(filename, AnalysisParameters)</a>
0002 <span class="comment">% Recovery of joint coordinates in a MVNX file</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%   INPUT</span>
0005 <span class="comment">%   - filename: name of the file to process (character string)</span>
0006 <span class="comment">%   - AnalysisParameters: parameters of the musculoskeletal analysis,</span>
0007 <span class="comment">%   automatically generated by the graphic interface 'Analysis'</span>
0008 <span class="comment">%   OUTPUT</span>
0009 <span class="comment">%   Results are automatically saved on the folder associated to each motion</span>
0010 <span class="comment">%   capture in variables 'ExperimentalData' and 'InverseKinematicsResults'.</span>
0011 <span class="comment">%________________________________________________________</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% Licence</span>
0014 <span class="comment">% Toolbox distributed under GPL 3.0 Licence</span>
0015 <span class="comment">%________________________________________________________</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% Authors : Antoine Muller, Charles Pontonnier, Pierre Puchaud and</span>
0018 <span class="comment">% Georges Dumont</span>
0019 <span class="comment">%________________________________________________________</span>
0020 
0021 disp([<span class="string">'Inverse kinematics ('</span> filename <span class="string">') ...'</span>])
0022 
0023 <span class="comment">%% Mvnx loading</span>
0024 tree = <a href="../../Functions/ExternLibrary/XSens/load_mvnx.html" class="code" title="function mvnx = load_mvnx(filename)">load_mvnx</a>(filename); tree.subject.frames.frame = tree.subject.frames.frame([1:end-1]); <span class="comment">%#ok&lt;NBRAK&gt;</span>
0025 
0026 <span class="comment">%% Experimental data</span>
0027 [~, frame1] = intersect({tree.subject.frames.frame.type},<span class="string">'normal'</span>);
0028 freq = tree.subject.frameRate;
0029 ExperimentalData.Time = 0:1/freq:((numel(tree.subject.frames.frame)-frame1)/freq);
0030 
0031 <span class="comment">%% Joint coordinates</span>
0032 InverseKinematicsResults.JointCoordinates = reshape([tree.subject.frames.frame.jointAngle],66,[]);
0033 InverseKinematicsResults.JointCoordinates = [zeros(1,size(InverseKinematicsResults.JointCoordinates,2));InverseKinematicsResults.JointCoordinates*pi/180];
0034 <span class="comment">% L5S1</span>
0035 InverseKinematicsResults.JointCoordinates(2:4,:) = <span class="keyword">...</span>
0036     [ + InverseKinematicsResults.JointCoordinates(4,:); <span class="keyword">...</span>
0037     + InverseKinematicsResults.JointCoordinates(2,:); <span class="keyword">...</span>
0038     + InverseKinematicsResults.JointCoordinates(3,:)];
0039 <span class="comment">% L4L3</span>
0040 InverseKinematicsResults.JointCoordinates(5:7,:) = <span class="keyword">...</span>
0041     [ + InverseKinematicsResults.JointCoordinates(7,:); <span class="keyword">...</span>
0042     + InverseKinematicsResults.JointCoordinates(5,:); <span class="keyword">...</span>
0043     + InverseKinematicsResults.JointCoordinates(6,:)];
0044 <span class="comment">% L1T12</span>
0045 InverseKinematicsResults.JointCoordinates(8:10,:) = <span class="keyword">...</span>
0046     [ + InverseKinematicsResults.JointCoordinates(10,:); <span class="keyword">...</span>
0047     + InverseKinematicsResults.JointCoordinates(8,:); <span class="keyword">...</span>
0048     + InverseKinematicsResults.JointCoordinates(9,:)];
0049 <span class="comment">% T9T8</span>
0050 InverseKinematicsResults.JointCoordinates(11:13,:) = <span class="keyword">...</span>
0051     [ + InverseKinematicsResults.JointCoordinates(13,:); <span class="keyword">...</span>
0052     + InverseKinematicsResults.JointCoordinates(11,:); <span class="keyword">...</span>
0053     + InverseKinematicsResults.JointCoordinates(12,:)];
0054 <span class="comment">% T1C7</span>
0055 InverseKinematicsResults.JointCoordinates(14:16,:) = <span class="keyword">...</span>
0056     [ + InverseKinematicsResults.JointCoordinates(16,:); <span class="keyword">...</span>
0057     + InverseKinematicsResults.JointCoordinates(14,:); <span class="keyword">...</span>
0058     + InverseKinematicsResults.JointCoordinates(15,:)];
0059 <span class="comment">% C1Head</span>
0060 InverseKinematicsResults.JointCoordinates(17:19,:) = <span class="keyword">...</span>
0061     [ + InverseKinematicsResults.JointCoordinates(19,:); <span class="keyword">...</span>
0062     + InverseKinematicsResults.JointCoordinates(17,:); <span class="keyword">...</span>
0063     + InverseKinematicsResults.JointCoordinates(18,:)];
0064 <span class="comment">% Right C7Shoulder</span>
0065 InverseKinematicsResults.JointCoordinates(20:22,:) = <span class="keyword">...</span>
0066     [ - InverseKinematicsResults.JointCoordinates(22,:); <span class="keyword">...</span>
0067     - InverseKinematicsResults.JointCoordinates(20,:); <span class="keyword">...</span>
0068     + InverseKinematicsResults.JointCoordinates(21,:)];
0069 <span class="comment">% Right Shoulder</span>
0070 InverseKinematicsResults.JointCoordinates(23:25,:) = <span class="keyword">...</span>
0071     [ - InverseKinematicsResults.JointCoordinates(25,:); <span class="keyword">...</span>
0072     - InverseKinematicsResults.JointCoordinates(23,:); <span class="keyword">...</span>
0073     + InverseKinematicsResults.JointCoordinates(24,:)];
0074 <span class="comment">% Right Elbow</span>
0075 InverseKinematicsResults.JointCoordinates(26:28,:) = <span class="keyword">...</span>
0076     [ - InverseKinematicsResults.JointCoordinates(28,:); <span class="keyword">...</span>
0077     - InverseKinematicsResults.JointCoordinates(26,:); <span class="keyword">...</span>
0078     + InverseKinematicsResults.JointCoordinates(27,:)];
0079 <span class="comment">% Right Wrist</span>
0080 InverseKinematicsResults.JointCoordinates(29:31,:) = <span class="keyword">...</span>
0081     [ - InverseKinematicsResults.JointCoordinates(31,:); <span class="keyword">...</span>
0082     - InverseKinematicsResults.JointCoordinates(29,:); <span class="keyword">...</span>
0083     + InverseKinematicsResults.JointCoordinates(30,:)];
0084 <span class="comment">% Left C7Shoulder</span>
0085 InverseKinematicsResults.JointCoordinates(32:34,:) = <span class="keyword">...</span>
0086     [ - InverseKinematicsResults.JointCoordinates(34,:); <span class="keyword">...</span>
0087     + InverseKinematicsResults.JointCoordinates(32,:); <span class="keyword">...</span>
0088     - InverseKinematicsResults.JointCoordinates(33,:)];
0089 <span class="comment">% Left Shoulder</span>
0090 InverseKinematicsResults.JointCoordinates(35:37,:) = <span class="keyword">...</span>
0091     [ - InverseKinematicsResults.JointCoordinates(37,:); <span class="keyword">...</span>
0092     + InverseKinematicsResults.JointCoordinates(35,:); <span class="keyword">...</span>
0093     - InverseKinematicsResults.JointCoordinates(36,:)];
0094 <span class="comment">% Left Elbow</span>
0095 InverseKinematicsResults.JointCoordinates(38:40,:) = <span class="keyword">...</span>
0096     [ - InverseKinematicsResults.JointCoordinates(40,:); <span class="keyword">...</span>
0097     + InverseKinematicsResults.JointCoordinates(38,:); <span class="keyword">...</span>
0098     - InverseKinematicsResults.JointCoordinates(39,:)];
0099 <span class="comment">% Left Wrist</span>
0100 InverseKinematicsResults.JointCoordinates(41:43,:) = <span class="keyword">...</span>
0101     [ - InverseKinematicsResults.JointCoordinates(43,:); <span class="keyword">...</span>
0102     + InverseKinematicsResults.JointCoordinates(41,:); <span class="keyword">...</span>
0103     - InverseKinematicsResults.JointCoordinates(42,:)];
0104 <span class="comment">% Right Hip</span>
0105 InverseKinematicsResults.JointCoordinates(44:46,:) = <span class="keyword">...</span>
0106     [ - InverseKinematicsResults.JointCoordinates(46,:); <span class="keyword">...</span>
0107     - InverseKinematicsResults.JointCoordinates(44,:); <span class="keyword">...</span>
0108     + InverseKinematicsResults.JointCoordinates(45,:)];
0109 <span class="comment">% Right Knee</span>
0110 InverseKinematicsResults.JointCoordinates(47:49,:) = <span class="keyword">...</span>
0111     [ + InverseKinematicsResults.JointCoordinates(49,:); <span class="keyword">...</span>
0112     - InverseKinematicsResults.JointCoordinates(47,:); <span class="keyword">...</span>
0113     + InverseKinematicsResults.JointCoordinates(48,:)];
0114 <span class="comment">% Right Ankle</span>
0115 InverseKinematicsResults.JointCoordinates(50:52,:) = <span class="keyword">...</span>
0116     [ - InverseKinematicsResults.JointCoordinates(52,:); <span class="keyword">...</span>
0117     - InverseKinematicsResults.JointCoordinates(50,:); <span class="keyword">...</span>
0118     + InverseKinematicsResults.JointCoordinates(51,:)];
0119 <span class="comment">% Right BallFoot</span>
0120 InverseKinematicsResults.JointCoordinates(53:55,:) = <span class="keyword">...</span>
0121     [ + InverseKinematicsResults.JointCoordinates(55,:); <span class="keyword">...</span>
0122     - InverseKinematicsResults.JointCoordinates(53,:); <span class="keyword">...</span>
0123     + InverseKinematicsResults.JointCoordinates(54,:)];
0124 <span class="comment">% Left Hip</span>
0125 InverseKinematicsResults.JointCoordinates(56:58,:) = <span class="keyword">...</span>
0126     [ - InverseKinematicsResults.JointCoordinates(58,:); <span class="keyword">...</span>
0127     + InverseKinematicsResults.JointCoordinates(56,:); <span class="keyword">...</span>
0128     - InverseKinematicsResults.JointCoordinates(57,:)];
0129 <span class="comment">% Left Knee</span>
0130 InverseKinematicsResults.JointCoordinates(59:61,:) = <span class="keyword">...</span>
0131     [ + InverseKinematicsResults.JointCoordinates(61,:); <span class="keyword">...</span>
0132     + InverseKinematicsResults.JointCoordinates(59,:); <span class="keyword">...</span>
0133     - InverseKinematicsResults.JointCoordinates(60,:)];
0134 <span class="comment">% Left Ankle</span>
0135 InverseKinematicsResults.JointCoordinates(62:64,:) = <span class="keyword">...</span>
0136     [ - InverseKinematicsResults.JointCoordinates(64,:); <span class="keyword">...</span>
0137     + InverseKinematicsResults.JointCoordinates(62,:); <span class="keyword">...</span>
0138     - InverseKinematicsResults.JointCoordinates(63,:)];
0139 <span class="comment">% Left BallFoot</span>
0140 InverseKinematicsResults.JointCoordinates(65:67,:) = <span class="keyword">...</span>
0141     [ + InverseKinematicsResults.JointCoordinates(67,:); <span class="keyword">...</span>
0142     + InverseKinematicsResults.JointCoordinates(65,:); <span class="keyword">...</span>
0143     - InverseKinematicsResults.JointCoordinates(66,:)];
0144 
0145 <span class="comment">% Pelvis</span>
0146 <span class="keyword">for</span> i = frame1:size(tree.subject.frames.frame,2)
0147     InverseKinematicsResults.PelvisPosition{i-frame1+1} = tree.subject.frames.frame(i).position(1,1:3)';
0148     InverseKinematicsResults.PelvisOrientation{i-frame1+1} = quat2rotm(tree.subject.frames.frame(i).orientation(1:4));
0149 <span class="keyword">end</span>
0150 
0151 <span class="comment">%% Position, velocity and acceleration</span>
0152 <span class="keyword">if</span> isfield(tree.subject.frames.frame, <span class="string">'position'</span>)
0153     InverseKinematicsResults.SegmentPosition = reshape([tree.subject.frames.frame(frame1:end).position],69,[]);
0154 <span class="keyword">end</span>
0155 <span class="keyword">if</span> isfield(tree.subject.frames.frame, <span class="string">'velocity'</span>)
0156     InverseKinematicsResults.SegmentVelocity = reshape([tree.subject.frames.frame(frame1:end).velocity],69,[]);
0157 <span class="keyword">end</span>
0158 <span class="keyword">if</span> isfield(tree.subject.frames.frame, <span class="string">'acceleration'</span>)
0159     InverseKinematicsResults.SegmentAcceleration = reshape([tree.subject.frames.frame(frame1:end).acceleration],69,[]);
0160 <span class="keyword">end</span>
0161 <span class="keyword">if</span> isfield(tree.subject.frames.frame, <span class="string">'orientation'</span>)
0162     InverseKinematicsResults.SegmentOrientation = reshape([tree.subject.frames.frame(frame1:end).orientation],92,[]);
0163 <span class="keyword">end</span>
0164 <span class="keyword">if</span> isfield(tree.subject.frames.frame, <span class="string">'angularVelocity'</span>)
0165     InverseKinematicsResults.SegmentAngularVelocity = reshape([tree.subject.frames.frame(frame1:end).angularVelocity],69,[]);
0166 <span class="keyword">end</span>
0167 <span class="keyword">if</span> isfield(tree.subject.frames.frame, <span class="string">'angularAcceleration'</span>)
0168     InverseKinematicsResults.SegmentAngularAcceleration = reshape([tree.subject.frames.frame(frame1:end).angularAcceleration],69,[]);
0169 <span class="keyword">end</span>
0170 
0171 <span class="comment">%% Filtering</span>
0172 <span class="keyword">if</span> AnalysisParameters.General.FilterActive
0173     PelvisPosition = zeros(3,numel(InverseKinematicsResults.PelvisPosition)); PelvisOrientation = zeros(9,numel(InverseKinematicsResults.PelvisPosition));
0174     f_filt = AnalysisParameters.General.FilterCutOff;
0175     InverseKinematicsResults.JointCoordinates = <a href="../../Functions/AlgoMathsModel/filt_data.html" class="code" title="function [data]=filt_data(data,f,f_mocap)">filt_data</a>(InverseKinematicsResults.JointCoordinates',f_filt,1/ExperimentalData.Time(2))';
0176     <span class="keyword">for</span> i = 1:numel(InverseKinematicsResults.PelvisPosition)
0177         PelvisPosition(:,i) = InverseKinematicsResults.PelvisPosition{i};
0178         PelvisOrientation(:,i) = [InverseKinematicsResults.PelvisOrientation{i}(:,1);InverseKinematicsResults.PelvisOrientation{i}(:,2);InverseKinematicsResults.PelvisOrientation{i}(:,3)]; <span class="comment">%#ok&lt;SAGROW&gt;</span>
0179     <span class="keyword">end</span>
0180     FiltPelvisPosition = <a href="../../Functions/AlgoMathsModel/filt_data.html" class="code" title="function [data]=filt_data(data,f,f_mocap)">filt_data</a>(PelvisPosition',f_filt,1/ExperimentalData.Time(2))';
0181     FiltPelvisOrientation = <a href="../../Functions/AlgoMathsModel/filt_data.html" class="code" title="function [data]=filt_data(data,f,f_mocap)">filt_data</a>(PelvisOrientation',f_filt,1/ExperimentalData.Time(2))';
0182     <span class="keyword">for</span> i = 1:numel(InverseKinematicsResults.PelvisPosition)
0183         InverseKinematicsResults.PelvisPosition{i} = FiltPelvisPosition(:,i);
0184         InverseKinematicsResults.PelvisOrientation{i} = [FiltPelvisOrientation(1:3,i) FiltPelvisOrientation(4:6,i) FiltPelvisOrientation(7:9,i)];
0185     <span class="keyword">end</span>
0186 <span class="keyword">end</span>
0187 
0188 <span class="comment">%% Save data</span>
0189 mkdir(filename);
0190 save([filename <span class="string">'/InverseKinematicsResults'</span>],<span class="string">'InverseKinematicsResults'</span>);
0191 save([filename <span class="string">'/ExperimentalData'</span>],<span class="string">'ExperimentalData'</span>);
0192 
0193 disp([<span class="string">'... Inverse kinematics ('</span> filename <span class="string">') done'</span>])
0194 
0195 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Wed 28-Apr-2021 14:02:00 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>