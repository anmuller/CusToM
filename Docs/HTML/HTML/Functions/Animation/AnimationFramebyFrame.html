<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of AnimationFramebyFrame</title>
  <meta name="keywords" content="AnimationFramebyFrame">
  <meta name="description" content="Computation of animation structure for animation">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html Functions --><!-- menu.html Animation -->
<h1>AnimationFramebyFrame
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Computation of animation structure for animation</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [animStruct]=AnimationFramebyFrame(ax,fig,filename,AnalysisParameters,ModelParameters,AnimateParameters,DataXSens,q,q6dof,PelvisPosition,PelvisOrientation,Markers_set,f_affich,Muscles,animStruct,real_markers,BiomechanicalModel,Human_model) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Computation of animation structure for animation

   INPUT
   - ax : axes of the  figure where will be plotted the animation
   - filename : nameof the used file
   - AnalysisParameters : parameters of the analysis
   - ModelParameters: parameters of the musculoskeletal model,
   - AnimateParameters : parameters of the animation, automatically
   generated by the graphic interface 'GenerateAnimate'
   - DataXSens : binary number to know if we are using XSens Data
   - q :  current coordinates of the model
   - q6dof : current coordinates of the 6 dof joint
   - PelvisPosition : Position of the pelvis
   - PelvisOrientation : Orientation of the pelvis
   - Markers_set : markers set (see the Documentation for the structure);
   - faffich : vector of the number of frames to be plotted
   - Muscles: muscles set (see the Documentation for the structure);
   - animStruct : structure with the data for animation
   - real_markers : Position of markers in experimental data
   - BiomechanicalModel : complete model (see the Documentation for the structure)
   - Human_model : osteo-articular model (see the Documentation for the structure)

 OUTPUT
   - animStruct : structure with the data for animation
________________________________________________________

 Licence
 Toolbox distributed under GPL 3.0 Licence
________________________________________________________

 Authors : Antoine Muller, Charles Pontonnier, Pierre Puchaud and
 Georges Dumont
________________________________________________________</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../Functions/AlgoMathsModel/find_solid_path.html" class="code" title="function [solid_1_path,solid_2_path]=find_solid_path(Human_model,i,k)">find_solid_path</a>	Identification of the hierarchical path between two solids</li><li><a href="ColorsAnimation.html" class="code" title="function [Colors]=ColorsAnimation(filename,Muscles,AnimateParameters,Human_model,ModelParameters,AnalysisParameters,options,Markers_set)">ColorsAnimation</a>	Preparing the colors for animation</li><li><a href="ForwardKinematicsAnimation8.html" class="code" title="function [Human_model, Muscles, Markers_set]=ForwardKinematicsAnimation8(Human_model,Markers_set,Muscles,q,j,seg_anim,muscles_anim,mod_marker_anim)">ForwardKinematicsAnimation8</a>	Computation of a forward kinematics step for the animation8</li><li><a href="ForwardKinematicsAnimation8XSens.html" class="code" title="function [Human_model]=ForwardKinematicsAnimation8XSens(Human_model,q,j)">ForwardKinematicsAnimation8XSens</a>	Computation of a forward kinematics step for the animation8 (adapted for</li><li><a href="OptionsChoices.html" class="code" title="function options=OptionsChoices(BiomechanicalModel,AnimateParameters)">OptionsChoices</a>	Extraction of choices for the animation</li><li><a href="PlotCylinder.html" class="code" title="function [F,V]=PlotCylinder(r,h)">PlotCylinder</a>	Generation of cylinder mesh for animation</li><li><a href="PlotFrame.html" class="code" title="function [h] = PlotFrame(P,R,scale)">PlotFrame</a>	Generation of a frame</li><li><a href="../../Functions/Dynamics/CalcCoM.html" class="code" title="function com=CalcCoM(Human_model)">CalcCoM</a>	Function that computes the global center of mass position.</li><li><a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>	function [h]=gpatch(F,V,C,CE,A,L)</li><li><a href="../../Functions/ExternalForces/FromExperiments/DataInC3D.html" class="code" title="function [ExternalForcesComputationResults] = DataInC3D(filename, BiomechanicalModel, AnalysisParameters)">DataInC3D</a>	Computation of the external forces</li><li><a href="../../Functions/MuscleForces/Wrapping/CylinderWrapping.html" class="code" title="function [L,Q,T,AnimPt_in_Rw,ind]=CylinderWrapping(P,S,R,ind)">CylinderWrapping</a>	Provide the length wrapping around a cylinder</li><li><a href="../../Functions/MuscleForces/Wrapping/Intersect_line_cylinder.html" class="code" title="function [bool]=Intersect_line_cylinder(P1,P2,R)">Intersect_line_cylinder</a>	Verify if the line intersect the cylinder</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="PlotAnimation.html" class="code" title="function [varargout] = PlotAnimation(ModelParameters, AnimateParameters)">PlotAnimation</a>	Generation of an animation</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [animStruct]=AnimationFramebyFrame(ax,fig,filename,AnalysisParameters,ModelParameters,AnimateParameters,DataXSens,q,q6dof,PelvisPosition,PelvisOrientation,Markers_set,f_affich,Muscles,animStruct,real_markers,BiomechanicalModel,Human_model)</a>
0002 <span class="comment">% Computation of animation structure for animation</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%   INPUT</span>
0005 <span class="comment">%   - ax : axes of the  figure where will be plotted the animation</span>
0006 <span class="comment">%   - filename : nameof the used file</span>
0007 <span class="comment">%   - AnalysisParameters : parameters of the analysis</span>
0008 <span class="comment">%   - ModelParameters: parameters of the musculoskeletal model,</span>
0009 <span class="comment">%   - AnimateParameters : parameters of the animation, automatically</span>
0010 <span class="comment">%   generated by the graphic interface 'GenerateAnimate'</span>
0011 <span class="comment">%   - DataXSens : binary number to know if we are using XSens Data</span>
0012 <span class="comment">%   - q :  current coordinates of the model</span>
0013 <span class="comment">%   - q6dof : current coordinates of the 6 dof joint</span>
0014 <span class="comment">%   - PelvisPosition : Position of the pelvis</span>
0015 <span class="comment">%   - PelvisOrientation : Orientation of the pelvis</span>
0016 <span class="comment">%   - Markers_set : markers set (see the Documentation for the structure);</span>
0017 <span class="comment">%   - faffich : vector of the number of frames to be plotted</span>
0018 <span class="comment">%   - Muscles: muscles set (see the Documentation for the structure);</span>
0019 <span class="comment">%   - animStruct : structure with the data for animation</span>
0020 <span class="comment">%   - real_markers : Position of markers in experimental data</span>
0021 <span class="comment">%   - BiomechanicalModel : complete model (see the Documentation for the structure)</span>
0022 <span class="comment">%   - Human_model : osteo-articular model (see the Documentation for the structure)</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% OUTPUT</span>
0025 <span class="comment">%   - animStruct : structure with the data for animation</span>
0026 <span class="comment">%________________________________________________________</span>
0027 <span class="comment">%</span>
0028 <span class="comment">% Licence</span>
0029 <span class="comment">% Toolbox distributed under GPL 3.0 Licence</span>
0030 <span class="comment">%________________________________________________________</span>
0031 <span class="comment">%</span>
0032 <span class="comment">% Authors : Antoine Muller, Charles Pontonnier, Pierre Puchaud and</span>
0033 <span class="comment">% Georges Dumont</span>
0034 <span class="comment">%________________________________________________________</span>
0035 
0036 options=<a href="OptionsChoices.html" class="code" title="function options=OptionsChoices(BiomechanicalModel,AnimateParameters)">OptionsChoices</a>(BiomechanicalModel,AnimateParameters);
0037 Colors=<a href="ColorsAnimation.html" class="code" title="function [Colors]=ColorsAnimation(filename,Muscles,AnimateParameters,Human_model,ModelParameters,AnalysisParameters,options,Markers_set)">ColorsAnimation</a>(filename,Muscles,AnimateParameters,Human_model,ModelParameters,AnalysisParameters,options,Markers_set);
0038 
0039 <span class="keyword">for</span> f=f_affich
0040     
0041     <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) || isequal(AnimateParameters.Mode, <span class="string">'Picture'</span>))
0042         clf  <span class="comment">% just for figure</span>
0043         ax = gca;
0044         axis equal
0045         set(ax,<span class="string">'visible'</span>,<span class="string">'off'</span>)
0046         camlight(ax, <span class="string">'headlight'</span>);
0047         xlim(AnimateParameters.xlim);
0048         ylim(AnimateParameters.ylim);
0049         zlim(AnimateParameters.zlim);
0050         view(AnimateParameters.view);
0051     <span class="keyword">end</span>
0052     
0053     <span class="comment">%Initialization animStruct</span>
0054     animStruct.Handles{f}=[];
0055     animStruct.Props{f}={};
0056     animStruct.Set{f}={};
0057     <span class="keyword">if</span>  isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; ~isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>) &amp;&amp; ~isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) &amp;&amp; ~isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>)
0058         hold on
0059     <span class="keyword">end</span>
0060     
0061     <span class="comment">%% forward kinematics</span>
0062     <span class="keyword">if</span> DataXSens
0063         qf = q(:,f);
0064         Human_model(1).p = PelvisPosition{f};
0065         Human_model(1).R = PelvisOrientation{f};
0066         [Human_model_bis] = <a href="ForwardKinematicsAnimation8XSens.html" class="code" title="function [Human_model]=ForwardKinematicsAnimation8XSens(Human_model,q,j)">ForwardKinematicsAnimation8XSens</a>(Human_model,qf,1);
0067     <span class="keyword">else</span>
0068         qf(1,:)=q6dof(6,f);
0069         qf(2:size(q,1),:)=q(2:<span class="keyword">end</span>,f);
0070         qf((size(q,1)+2):(size(q,1)+6),:)=q6dof(1:5,f);
0071         bone_anim= options.seg_anim || options.AnatLandmark || isfield(options,<span class="string">'num_mus'</span>);
0072         muscle_anim= options.muscles_anim || isfield(options,<span class="string">'num_mus'</span>);
0073         [Human_model_bis,Muscles_test, Markers_set_test]=<span class="keyword">...</span>
0074             <a href="ForwardKinematicsAnimation8.html" class="code" title="function [Human_model, Muscles, Markers_set]=ForwardKinematicsAnimation8(Human_model,Markers_set,Muscles,q,j,seg_anim,muscles_anim,mod_marker_anim)">ForwardKinematicsAnimation8</a>(Human_model,Markers_set,Muscles,qf,find(~[Human_model.mother]),<span class="keyword">...</span>
0075             bone_anim,muscle_anim,options.mod_marker_anim);
0076     <span class="keyword">end</span>
0077     
0078     
0079     
0080     
0081     
0082     
0083     
0084     <span class="comment">%% Segments</span>
0085     <span class="keyword">if</span> options.seg_anim
0086         V_seg=[];
0087         F_seg=[];
0088         liste=find([Human_model_bis.Visual]);
0089         <span class="keyword">for</span> j=liste
0090             pts = Human_model_bis(j).pos_pts_anim';
0091             <span class="keyword">if</span> size(pts,1)&gt;1
0092                 F_seg =[F_seg; nchoosek(1:size(pts,1),2)+length(V_seg)]; <span class="comment">%#ok&lt;AGROW&gt; %need to be done before V_seg !</span>
0093             <span class="keyword">else</span>
0094                 F_seg =[F_seg; length(V_seg) length(V_seg)+1]; <span class="comment">%#ok&lt;AGROW&gt; %need to be done before V_seg !</span>
0095             <span class="keyword">end</span>
0096             V_seg = [V_seg; pts];  <span class="comment">%#ok&lt;AGROW&gt;</span>
0097         <span class="keyword">end</span>
0098         <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0099                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span>
0100                 || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>) <span class="keyword">...</span>
0101                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>))
0102             finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0103             <span class="keyword">if</span> F_seg(1)==0 &amp;&amp; length(F_seg)==2
0104                 h_seg = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_seg(2),V_seg,[],0.4*[1 1 1],1,4);
0105             <span class="keyword">else</span>
0106                 h_seg = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_seg,V_seg,[],0.4*[1 1 1],1,4);
0107             <span class="keyword">end</span>
0108             
0109             copyobj(h_seg,ax);
0110             close(finv);
0111         <span class="keyword">elseif</span> f==f_affich(1)
0112             h_seg = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_seg,V_seg,[],0.4*[1 1 1],1,4);
0113         <span class="keyword">end</span>
0114         animStruct.Handles{f} = [animStruct.Handles{f} h_seg];
0115         animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Vertices'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0116         animStruct.Set{f} = {animStruct.Set{f}{:},V_seg};
0117     <span class="keyword">end</span>
0118     
0119     <span class="comment">%% Bones</span>
0120     <span class="keyword">if</span> options.bone_anim <span class="comment">% To do % to concatenate bones;</span>
0121         <span class="keyword">if</span> isfield(Human_model_bis,<span class="string">'V'</span>)
0122             X=[];
0123             Fbones=[];
0124             
0125             jj=find(cellfun(@(x) numel(x), {Human_model_bis.V}));
0126             <span class="keyword">for</span> j=1:length(jj)
0127                 jjj=jj(j);
0128                 cur_nb_V=length(Human_model_bis(jjj).V);
0129                 cur_nb_F=length(Human_model_bis(jjj).F);
0130                 tot_nb_F=length(Fbones);
0131                 tot_nb_V=length(X);
0132                 Fbones((1:cur_nb_F)+tot_nb_F,:)=Human_model_bis(jjj).F+tot_nb_V; <span class="comment">%#ok&lt;AGROW&gt;</span>
0133                 onearray = ones([1,cur_nb_V]);
0134                 <span class="keyword">if</span> isempty(Human_model_bis(jjj).V)
0135                     temp=[];
0136                 <span class="keyword">else</span>
0137                     temp=(Human_model_bis(jjj).Tc_R0_Ri*<span class="keyword">...</span>
0138                         [Human_model_bis(jjj).V';onearray ])';
0139                 <span class="keyword">end</span>
0140                 X = [ X ;<span class="keyword">...</span>
0141                     temp]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0142             <span class="keyword">end</span>
0143             <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0144                     || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span>
0145                     || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>) <span class="keyword">...</span>
0146                     || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>))
0147                 finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0148                 hc = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(Fbones,X(:,1:3),[227 218 201]/255*0.9,<span class="string">'none'</span>);
0149                 copyobj(hc,ax);
0150                 close(finv);
0151             <span class="keyword">elseif</span> f==f_affich(1)
0152                 hc = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(Fbones,X(:,1:3),[227 218 201]/255*0.9,<span class="string">'none'</span>);
0153             <span class="keyword">end</span>
0154             animStruct.Handles{f}=[animStruct.Handles{f} hc];
0155             animStruct.Props{f}={ animStruct.Props{f}{:}, <span class="string">'Vertices'</span>};
0156             animStruct.Set{f}={animStruct.Set{f}{:},X(:,1:3)};
0157         <span class="keyword">else</span>
0158             <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; ~isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>)
0159                 warning(<span class="string">'No osteo-articular bone model is available'</span>);
0160             <span class="keyword">end</span>
0161         <span class="keyword">end</span>
0162     <span class="keyword">end</span>
0163     
0164     
0165     
0166     
0167     <span class="comment">%% Markers</span>
0168     <span class="comment">% Modï¿½le</span>
0169     <span class="keyword">if</span> options.mod_marker_anim || options.exp_marker_anim
0170         Vsmk=[];
0171         <span class="keyword">if</span> options.mod_marker_anim <span class="comment">%% Markers on the model</span>
0172             <span class="keyword">for</span> i_m = 1:numel(Markers_set_test)
0173                 cur_Vs=Markers_set_test(i_m).pos_anim';
0174                 Vsmk=[Vsmk;cur_Vs]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0175             <span class="keyword">end</span>
0176         <span class="keyword">end</span>
0177         <span class="comment">% XP</span>
0178         <span class="keyword">if</span> options.exp_marker_anim <span class="comment">%% Experimental markers</span>
0179             <span class="keyword">for</span> i_m = 1:numel(Markers_set_test)
0180                 cur_Vs=real_markers(i_m).position(f,:);
0181                 Vsmk=[Vsmk;cur_Vs]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0182             <span class="keyword">end</span>
0183         <span class="keyword">end</span>
0184         <span class="keyword">if</span> f==f_affich(1) || (isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>))
0185             m = patch(ax,<span class="string">'Faces'</span>,Colors.fmk,<span class="string">'Vertices'</span>,Vsmk,<span class="string">'FaceColor'</span>,<span class="string">'none'</span>,<span class="string">'FaceVertexCData'</span>,Colors.C_mk,<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
0186             m.Marker=<span class="string">'o'</span>;
0187             m.MarkerFaceColor=<span class="string">'flat'</span>;
0188             m.MarkerEdgeColor=<span class="string">'k'</span>;
0189             m.MarkerSize=6;
0190         <span class="keyword">end</span>
0191         animStruct.Handles{f}=[animStruct.Handles{f} m];
0192         animStruct.Props{f}={ animStruct.Props{f}{:},<span class="string">'Vertices'</span>};
0193         animStruct.Set{f}={animStruct.Set{f}{:},Vsmk};
0194     <span class="keyword">end</span>
0195     
0196     
0197     
0198     
0199     <span class="comment">%% Anatomical landmarks</span>
0200     
0201     <span class="keyword">if</span> options.AnatLandmark
0202         scale=0.3;
0203         <span class="keyword">if</span> ~isempty(options.Segment)
0204             anat_pointsold=[];
0205             labels=[];
0206             p1=[];p2=[];p3=[];
0207             R11=[];R12=[];R13=[];R21=[];R22=[];R23=[];R31=[];R32=[];R33=[];
0208             <span class="keyword">for</span> index=options.Segment
0209                 <span class="keyword">if</span> ~isempty( BiomechanicalModel.OsteoArticularModel(index).anat_position)
0210                     anat_points=BiomechanicalModel.OsteoArticularModel(index).anat_position(:,2);
0211                     <span class="keyword">for</span> each_pt=1:size(anat_points,1)
0212                         anat_points{each_pt}=Human_model_bis(index).R*(anat_points{each_pt}+BiomechanicalModel.OsteoArticularModel(index).c)+Human_model_bis(index).p;
0213                     <span class="keyword">end</span>
0214                     anat_pointsold = [anat_pointsold ; anat_points];
0215                     
0216                     p1=[p1 Human_model_bis(index).p(1)];
0217                     p2=[p2 Human_model_bis(index).p(2)];
0218                     p3=[p3 Human_model_bis(index).p(3)];
0219                     
0220                     R11=[R11 Human_model_bis(index).R(1,1) ];
0221                     R12=[R12 Human_model_bis(index).R(1,2)];
0222                     R13=[R13 Human_model_bis(index).R(1,3)];
0223                     
0224                     
0225                     R21=[R21 Human_model_bis(index).R(2,1) ];
0226                     R22=[R22 Human_model_bis(index).R(2,2)];
0227                     R23=[R23 Human_model_bis(index).R(2,3)];
0228                     
0229                     
0230                     R31=[R31 Human_model_bis(index).R(3,1) ];
0231                     R32=[R32 Human_model_bis(index).R(3,2)];
0232                     R33=[R33 Human_model_bis(index).R(3,3)];
0233                     
0234                     labels=[labels; BiomechanicalModel.OsteoArticularModel(index).anat_position(:,1)];
0235                     
0236                 <span class="keyword">end</span>
0237                 
0238                 
0239             <span class="keyword">end</span>
0240             
0241             
0242             
0243             C_col_p=repmat([253,108,168]/255,[size(anat_pointsold,1) 1]);
0244             
0245             an=[anat_pointsold{:}]';
0246             
0247             <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0248                     || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span>
0249                     || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>) <span class="keyword">...</span>
0250                     || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>))
0251                 finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0252                 hanat = patch(ax,<span class="string">'Faces'</span>,1:size(anat_pointsold,1),<span class="string">'Vertices'</span>,[anat_pointsold{:}]',<span class="string">'FaceColor'</span>,<span class="string">'none'</span>,<span class="string">'FaceVertexCData'</span>,C_col_p,<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
0253                 hanat.Marker=<span class="string">'o'</span>;
0254                 hanat.MarkerFaceColor=<span class="string">'flat'</span>;
0255                 hanat.MarkerEdgeColor=<span class="string">'k'</span>;
0256                 hanat.MarkerSize=6;
0257                 copyobj(hanat,ax);
0258                 
0259                 hframe=[];
0260                 <span class="keyword">for</span> index=options.Segment
0261                     hframe=[hframe <a href="PlotFrame.html" class="code" title="function [h] = PlotFrame(P,R,scale)">PlotFrame</a>(Human_model_bis(index).p,Human_model_bis(index).R,scale)];
0262                 <span class="keyword">end</span>
0263                 copyobj(hframe,ax);
0264                 
0265                 <span class="keyword">if</span> options.AnatLandmark_names
0266                     
0267                     htext=text(an(:,1),an(:,2),an(:,3),labels);
0268                     copyobj(htext,ax);
0269                     close(finv);
0270                 <span class="keyword">end</span>
0271             <span class="keyword">else</span>
0272                 <span class="keyword">if</span> f==f_affich(1)
0273                     hanat = patch(ax,<span class="string">'Faces'</span>,1:size(anat_pointsold,1),<span class="string">'Vertices'</span>,[anat_pointsold{:}]',<span class="string">'FaceColor'</span>,<span class="string">'none'</span>,<span class="string">'FaceVertexCData'</span>,C_col_p,<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
0274                     hanat.Marker=<span class="string">'o'</span>;
0275                     hanat.MarkerFaceColor=<span class="string">'flat'</span>;
0276                     hanat.MarkerEdgeColor=<span class="string">'k'</span>;
0277                     hanat.MarkerSize=6;
0278                     hframe=[];
0279                     <span class="keyword">for</span> index=options.Segment'
0280                         hframe=[hframe <a href="PlotFrame.html" class="code" title="function [h] = PlotFrame(P,R,scale)">PlotFrame</a>(Human_model_bis(index).p,Human_model_bis(index).R,scale)];
0281                     <span class="keyword">end</span>
0282                     <span class="keyword">if</span> options.AnatLandmark_names
0283                         
0284                         htext=text(an(:,1),an(:,2),an(:,3),labels);
0285                     <span class="keyword">end</span>
0286                 <span class="keyword">end</span>
0287                 
0288                 animStruct.Handles{f} = [animStruct.Handles{f} hanat];
0289                 animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Vertices'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0290                 
0291                 animStruct.Set{f} = {animStruct.Set{f}{:},an};
0292                 
0293                 
0294                 
0295                 <span class="keyword">for</span> num_fleche=0:length(options.Segment)-1
0296                     animStruct.Handles{f} = [animStruct.Handles{f} hframe(6*num_fleche+1) hframe(6*num_fleche+1) hframe(6*num_fleche+1) hframe(6*num_fleche+1) hframe(6*num_fleche+1) hframe(6*num_fleche+1) ];
0297                     animStruct.Handles{f} = [animStruct.Handles{f} hframe(6*num_fleche+2) hframe(6*num_fleche+2) hframe(6*num_fleche+2) hframe(6*num_fleche+2) hframe(6*num_fleche+2) hframe(6*num_fleche+2)];
0298                     animStruct.Handles{f} = [animStruct.Handles{f} hframe(6*num_fleche+3) hframe(6*num_fleche+3) hframe(6*num_fleche+3) hframe(6*num_fleche+3) hframe(6*num_fleche+3) hframe(6*num_fleche+3) ];
0299                     animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'XData'</span>,<span class="string">'YData'</span>,<span class="string">'ZData'</span>,<span class="string">'UData'</span>,<span class="string">'VData'</span>,<span class="string">'WData'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0300                     animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'XData'</span>,<span class="string">'YData'</span>,<span class="string">'ZData'</span>,<span class="string">'UData'</span>,<span class="string">'VData'</span>,<span class="string">'WData'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0301                     animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'XData'</span>,<span class="string">'YData'</span>,<span class="string">'ZData'</span>,<span class="string">'UData'</span>,<span class="string">'VData'</span>,<span class="string">'WData'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0302                     
0303                     animStruct.Set{f} = {animStruct.Set{f}{:},p1(num_fleche+1),p2(num_fleche+1),p3(num_fleche+1),R11(num_fleche+1) ,R12(num_fleche+1),R13(num_fleche+1)};
0304                     animStruct.Set{f} = {animStruct.Set{f}{:},p1(num_fleche+1),p2(num_fleche+1),p3(num_fleche+1),R21(num_fleche+1),R22(num_fleche+1),R23(num_fleche+1)};
0305                     animStruct.Set{f} = {animStruct.Set{f}{:},p1(num_fleche+1),p2(num_fleche+1),p3(num_fleche+1),R31(num_fleche+1),R32(num_fleche+1),R33(num_fleche+1)};
0306                     
0307                     animStruct.Handles{f} = [animStruct.Handles{f} hframe(6*num_fleche+4) hframe(6*num_fleche+4) hframe(6*num_fleche+4)  ];
0308                     animStruct.Handles{f} = [animStruct.Handles{f} hframe(6*num_fleche+5) hframe(6*num_fleche+5) hframe(6*num_fleche+5)  ];
0309                     animStruct.Handles{f} = [animStruct.Handles{f} hframe(6*num_fleche+6) hframe(6*num_fleche+6) hframe(6*num_fleche+6)  ];
0310                     animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Position'</span>,<span class="string">'String'</span>,<span class="string">'FontWeight'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0311                     animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Position'</span>,<span class="string">'String'</span>,<span class="string">'FontWeight'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0312                     animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Position'</span>,<span class="string">'String'</span>,<span class="string">'FontWeight'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0313                     animStruct.Set{f} = {animStruct.Set{f}{:},[p1(num_fleche+1)+R11(num_fleche+1)*scale, p2(num_fleche+1)+R12(num_fleche+1)*scale, p3(num_fleche+1)+R13(num_fleche+1)*scale],<span class="string">'x'</span>,<span class="string">'bold'</span>};
0314                     animStruct.Set{f} = {animStruct.Set{f}{:},[p1(num_fleche+1)+R21(num_fleche+1)*scale, p2(num_fleche+1)+R22(num_fleche+1)*scale, p3(num_fleche+1)+R23(num_fleche+1)*scale],<span class="string">'y'</span>,<span class="string">'bold'</span>};
0315                     animStruct.Set{f} = {animStruct.Set{f}{:},[p1(num_fleche+1)+R31(num_fleche+1)*scale, p2(num_fleche+1)+R32(num_fleche+1)*scale, p3(num_fleche+1)+R33(num_fleche+1)*scale],<span class="string">'z'</span>,<span class="string">'bold'</span>};
0316                     
0317                 <span class="keyword">end</span>
0318                 
0319                 <span class="keyword">if</span> options.AnatLandmark_names
0320                     
0321                     <span class="keyword">for</span> tt=1:size(htext,1)
0322                         animStruct.Handles{f} = [animStruct.Handles{f} htext(tt) htext(tt)];
0323                         animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Position'</span>,<span class="string">'String'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0324                         animStruct.Set{f} = {animStruct.Set{f}{:},an(tt,:),labels(tt)};
0325                     <span class="keyword">end</span>
0326                     
0327                 <span class="keyword">end</span>
0328                 
0329             <span class="keyword">end</span>
0330             
0331             
0332             <span class="comment">% Only concerned bones</span>
0333             V_seg=[];
0334             F_seg=[];
0335             liste=intersect(find([Human_model_bis.Visual]),options.Segment);
0336             <span class="keyword">for</span> j=liste
0337                 pts = Human_model_bis(j).pos_pts_anim';
0338                 <span class="keyword">if</span> size(pts,1)&gt;1
0339                     F_seg =[F_seg; nchoosek(1:size(pts,1),2)+length(V_seg)]; <span class="comment">%#ok&lt;AGROW&gt; %need to be done before V_seg !</span>
0340                 <span class="keyword">else</span>
0341                     F_seg =[F_seg; length(V_seg) length(V_seg)+1]; <span class="comment">%#ok&lt;AGROW&gt; %need to be done before V_seg !</span>
0342                 <span class="keyword">end</span>
0343                 V_seg = [V_seg; pts];  <span class="comment">%#ok&lt;AGROW&gt;</span>
0344             <span class="keyword">end</span>
0345             <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0346                     || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span>
0347                     || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>) <span class="keyword">...</span>
0348                     || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>))
0349                 finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0350                 <span class="keyword">if</span> F_seg(1)==0 &amp;&amp; length(F_seg)==2
0351                     h_seg = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_seg(2),V_seg,[],0.4*[1 1 1],1,4);
0352                 <span class="keyword">else</span>
0353                     h_seg = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_seg,V_seg,[],0.4*[1 1 1],1,4);
0354                 <span class="keyword">end</span>
0355                 
0356                 copyobj(h_seg,ax);
0357                 close(finv);
0358             <span class="keyword">elseif</span> f==f_affich(1)
0359                 h_seg = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_seg,V_seg,[],0.4*[1 1 1],1,4);
0360             <span class="keyword">end</span>
0361             animStruct.Handles{f} = [animStruct.Handles{f} h_seg];
0362             animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Vertices'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0363             animStruct.Set{f} = {animStruct.Set{f}{:},V_seg};
0364             
0365         <span class="keyword">end</span>
0366     <span class="keyword">end</span>
0367     
0368     <span class="comment">%% Muscles in detail</span>
0369     <span class="keyword">if</span> isfield(options,<span class="string">'num_mus'</span>)
0370         concerned_bones=[];
0371         <span class="keyword">for</span> k=options.num_mus
0372             solidmin=min(BiomechanicalModel.Muscles(k).num_solid);
0373             solidmax=max(BiomechanicalModel.Muscles(k).num_solid);
0374             [solid_1_path,solid_2_path]=<a href="../../Functions/AlgoMathsModel/find_solid_path.html" class="code" title="function [solid_1_path,solid_2_path]=find_solid_path(Human_model,i,k)">find_solid_path</a>(BiomechanicalModel.OsteoArticularModel,solidmin,solidmax);
0375             solid_path=unique([solid_1_path,solid_2_path]);
0376             concerned_bones = unique([concerned_bones, solid_path]);
0377         <span class="keyword">end</span>
0378         
0379         scale=0.3;
0380         anat_pointsold=[];
0381         labels=[];
0382         p1=[];p2=[];p3=[];
0383         R11=[];R12=[];R13=[];R21=[];R22=[];R23=[];R31=[];R32=[];R33=[];
0384         <span class="keyword">for</span> index=options.num_mus
0385             <span class="keyword">for</span> k=1:size(BiomechanicalModel.Muscles(index).num_solid,1)
0386                 temp1=BiomechanicalModel.Muscles(index).num_solid(k);
0387                 temp2=BiomechanicalModel.Muscles(index).num_markers(k);
0388                 anat_points=BiomechanicalModel.OsteoArticularModel(temp1).anat_position(temp2,2);
0389                 anat_points=anat_points{:};
0390                 anat_points=Human_model_bis(temp1).R*(anat_points+BiomechanicalModel.OsteoArticularModel(temp1).c)+Human_model_bis(temp1).p;
0391                 anat_pointsold = [anat_pointsold ; {anat_points}];
0392                 
0393                 p1=[p1 Human_model_bis(temp1).p(1)];
0394                 p2=[p2 Human_model_bis(temp1).p(2)];
0395                 p3=[p3 Human_model_bis(temp1).p(3)];
0396                 
0397                 R11=[R11 Human_model_bis(temp1).R(1,1) ];
0398                 R12=[R12 Human_model_bis(temp1).R(1,2)];
0399                 R13=[R13 Human_model_bis(temp1).R(1,3)];
0400                 
0401                 
0402                 R21=[R21 Human_model_bis(temp1).R(2,1) ];
0403                 R22=[R22 Human_model_bis(temp1).R(2,2)];
0404                 R23=[R23 Human_model_bis(temp1).R(2,3)];
0405                 
0406                 
0407                 R31=[R31 Human_model_bis(temp1).R(3,1) ];
0408                 R32=[R32 Human_model_bis(temp1).R(3,2)];
0409                 R33=[R33 Human_model_bis(temp1).R(3,3)];
0410                 
0411                 labels=[labels; BiomechanicalModel.OsteoArticularModel(temp1).anat_position(temp2,1)];
0412                 
0413             <span class="keyword">end</span>
0414         <span class="keyword">end</span>
0415         
0416         
0417         C_col_p=repmat([255,0,0]/255,[size(anat_pointsold,1) 1]);
0418         
0419         an=[anat_pointsold{:}]';
0420         
0421         <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0422                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span>
0423                 || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>) <span class="keyword">...</span>
0424                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>))
0425             finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0426             hanat = patch(ax,<span class="string">'Faces'</span>,1:size(anat_pointsold,1),<span class="string">'Vertices'</span>,[anat_pointsold{:}]',<span class="string">'FaceColor'</span>,<span class="string">'none'</span>,<span class="string">'FaceVertexCData'</span>,C_col_p,<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
0427             hanat.Marker=<span class="string">'o'</span>;
0428             hanat.MarkerFaceColor=<span class="string">'flat'</span>;
0429             hanat.MarkerEdgeColor=<span class="string">'k'</span>;
0430             hanat.MarkerSize=6;
0431             copyobj(hanat,ax);
0432             
0433             hframe=[];
0434             <span class="keyword">for</span> index=concerned_bones
0435                 hframe=[hframe <a href="PlotFrame.html" class="code" title="function [h] = PlotFrame(P,R,scale)">PlotFrame</a>(Human_model_bis(index).p,Human_model_bis(index).R,scale)];
0436             <span class="keyword">end</span>
0437             copyobj(hframe,ax);
0438             
0439             
0440             htext=text(an(:,1),an(:,2),an(:,3),labels);
0441             copyobj(htext,ax);
0442             close(finv);
0443         <span class="keyword">else</span>
0444             <span class="keyword">if</span> f==f_affich(1)
0445                 hanat = patch(ax,<span class="string">'Faces'</span>,1:size(anat_pointsold,1),<span class="string">'Vertices'</span>,[anat_pointsold{:}]',<span class="string">'FaceColor'</span>,<span class="string">'None'</span>,<span class="string">'FaceVertexCData'</span>,C_col_p,<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
0446                 hanat.Marker=<span class="string">'o'</span>;
0447                 hanat.MarkerFaceColor=<span class="string">'flat'</span>;
0448                 hanat.MarkerEdgeColor=<span class="string">'k'</span>;
0449                 hanat.MarkerSize=6;
0450                 
0451                 hframe=[];
0452                 <span class="keyword">for</span> index=concerned_bones
0453                     hframe=[hframe <a href="PlotFrame.html" class="code" title="function [h] = PlotFrame(P,R,scale)">PlotFrame</a>(Human_model_bis(index).p,Human_model_bis(index).R,scale)];
0454                 <span class="keyword">end</span>
0455                 
0456                 htext=text(an(:,1),an(:,2),an(:,3),labels);
0457                 
0458             <span class="keyword">end</span>
0459             
0460             animStruct.Handles{f} = [animStruct.Handles{f} hanat];
0461             animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Vertices'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0462             
0463             animStruct.Set{f} = {animStruct.Set{f}{:},an};
0464             
0465             
0466             
0467             <span class="keyword">for</span> num_fleche=0:(length(concerned_bones)-1)
0468                 animStruct.Handles{f} = [animStruct.Handles{f} hframe(6*num_fleche+1) hframe(6*num_fleche+1) hframe(6*num_fleche+1) hframe(6*num_fleche+1) hframe(6*num_fleche+1) hframe(6*num_fleche+1) ];
0469                 animStruct.Handles{f} = [animStruct.Handles{f} hframe(6*num_fleche+2) hframe(6*num_fleche+2) hframe(6*num_fleche+2) hframe(6*num_fleche+2) hframe(6*num_fleche+2) hframe(6*num_fleche+2)];
0470                 animStruct.Handles{f} = [animStruct.Handles{f} hframe(6*num_fleche+3) hframe(6*num_fleche+3) hframe(6*num_fleche+3) hframe(6*num_fleche+3) hframe(6*num_fleche+3) hframe(6*num_fleche+3) ];
0471                 animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'XData'</span>,<span class="string">'YData'</span>,<span class="string">'ZData'</span>,<span class="string">'UData'</span>,<span class="string">'VData'</span>,<span class="string">'WData'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0472                 animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'XData'</span>,<span class="string">'YData'</span>,<span class="string">'ZData'</span>,<span class="string">'UData'</span>,<span class="string">'VData'</span>,<span class="string">'WData'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0473                 animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'XData'</span>,<span class="string">'YData'</span>,<span class="string">'ZData'</span>,<span class="string">'UData'</span>,<span class="string">'VData'</span>,<span class="string">'WData'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0474                 
0475                 animStruct.Set{f} = {animStruct.Set{f}{:},p1(num_fleche+1),p2(num_fleche+1),p3(num_fleche+1),R11(num_fleche+1) ,R12(num_fleche+1),R13(num_fleche+1)};
0476                 animStruct.Set{f} = {animStruct.Set{f}{:},p1(num_fleche+1),p2(num_fleche+1),p3(num_fleche+1),R21(num_fleche+1),R22(num_fleche+1),R23(num_fleche+1)};
0477                 animStruct.Set{f} = {animStruct.Set{f}{:},p1(num_fleche+1),p2(num_fleche+1),p3(num_fleche+1),R31(num_fleche+1),R32(num_fleche+1),R33(num_fleche+1)};
0478                 
0479                 animStruct.Handles{f} = [animStruct.Handles{f} hframe(6*num_fleche+4) hframe(6*num_fleche+4) hframe(6*num_fleche+4)  ];
0480                 animStruct.Handles{f} = [animStruct.Handles{f} hframe(6*num_fleche+5) hframe(6*num_fleche+5) hframe(6*num_fleche+5)  ];
0481                 animStruct.Handles{f} = [animStruct.Handles{f} hframe(6*num_fleche+6) hframe(6*num_fleche+6) hframe(6*num_fleche+6)  ];
0482                 animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Position'</span>,<span class="string">'String'</span>,<span class="string">'FontWeight'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0483                 animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Position'</span>,<span class="string">'String'</span>,<span class="string">'FontWeight'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0484                 animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Position'</span>,<span class="string">'String'</span>,<span class="string">'FontWeight'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0485                 animStruct.Set{f} = {animStruct.Set{f}{:},[p1(num_fleche+1)+R11(num_fleche+1)*scale, p2(num_fleche+1)+R12(num_fleche+1)*scale, p3(num_fleche+1)+R13(num_fleche+1)*scale],<span class="string">'x'</span>,<span class="string">'bold'</span>};
0486                 animStruct.Set{f} = {animStruct.Set{f}{:},[p1(num_fleche+1)+R21(num_fleche+1)*scale, p2(num_fleche+1)+R22(num_fleche+1)*scale, p3(num_fleche+1)+R23(num_fleche+1)*scale],<span class="string">'y'</span>,<span class="string">'bold'</span>};
0487                 animStruct.Set{f} = {animStruct.Set{f}{:},[p1(num_fleche+1)+R31(num_fleche+1)*scale, p2(num_fleche+1)+R32(num_fleche+1)*scale, p3(num_fleche+1)+R33(num_fleche+1)*scale],<span class="string">'z'</span>,<span class="string">'bold'</span>};
0488                 
0489             <span class="keyword">end</span>
0490             
0491             
0492             
0493             <span class="keyword">for</span> tt=1:size(htext,1)
0494                 animStruct.Handles{f} = [animStruct.Handles{f} htext(tt) htext(tt)];
0495                 animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Position'</span>,<span class="string">'String'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0496                 animStruct.Set{f} = {animStruct.Set{f}{:},an(tt,:),labels(tt)};
0497             <span class="keyword">end</span>
0498             
0499         <span class="keyword">end</span>
0500         
0501         <span class="comment">% Only concerned bones</span>
0502         
0503         V_seg=[];
0504         F_seg=[];
0505         liste=intersect(find([Human_model_bis.Visual]),concerned_bones);
0506         <span class="keyword">for</span> j=liste
0507             pts = Human_model_bis(j).pos_pts_anim';
0508             <span class="keyword">if</span> size(pts,1)&gt;1
0509                 F_seg =[F_seg; nchoosek(1:size(pts,1),2)+length(V_seg)]; <span class="comment">%#ok&lt;AGROW&gt; %need to be done before V_seg !</span>
0510             <span class="keyword">else</span>
0511                 F_seg =[F_seg; length(V_seg) length(V_seg)+1]; <span class="comment">%#ok&lt;AGROW&gt; %need to be done before V_seg !</span>
0512             <span class="keyword">end</span>
0513             V_seg = [V_seg; pts];  <span class="comment">%#ok&lt;AGROW&gt;</span>
0514         <span class="keyword">end</span>
0515         <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0516                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span>
0517                 || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>) <span class="keyword">...</span>
0518                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>))
0519             finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0520             <span class="keyword">if</span> F_seg(1)==0 &amp;&amp; length(F_seg)==2
0521                 h_seg = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_seg(2),V_seg,[],0.4*[1 1 1],1,4);
0522             <span class="keyword">else</span>
0523                 h_seg = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_seg,V_seg,[],0.4*[1 1 1],1,4);
0524             <span class="keyword">end</span>
0525             
0526             copyobj(h_seg,ax);
0527             close(finv);
0528         <span class="keyword">elseif</span> f==f_affich(1)
0529             h_seg = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_seg,V_seg,[],0.4*[1 1 1],1,4);
0530         <span class="keyword">end</span>
0531         animStruct.Handles{f} = [animStruct.Handles{f} h_seg];
0532         animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Vertices'</span>}; <span class="comment">%#ok&lt;*CCAT&gt;</span>
0533         animStruct.Set{f} = {animStruct.Set{f}{:},V_seg};
0534         
0535         
0536         
0537         Fmu=[];
0538         CEmu=[];
0539         Vmu=[];
0540         color_mus = [1 0 0];
0541         ind_mu=find([Muscles_test.exist]==1);
0542         <span class="keyword">for</span> i_mu = 1:numel(ind_mu)
0543             mu=ind_mu(i_mu);
0544             <span class="keyword">if</span> ~isempty(intersect( options.num_mus,mu))
0545                 pts_mu = Muscles_test(mu).pos_pts';
0546                 nbpts_mu = size(pts_mu,1);
0547                 <span class="keyword">if</span> isfield(Muscles(mu),<span class="string">'wrap'</span>) &amp;&amp; ~isempty(Muscles(mu).wrap) &amp;&amp; ~isempty(Muscles(mu).wrap{1})
0548                     <span class="comment">% find the wrap</span>
0549                     j_wr=1;
0550                     <span class="keyword">for</span> i_wr=1:size(Human_model,2)
0551                         <span class="keyword">if</span> ~isempty(Human_model(i_wr).wrap)
0552                             Solid_wrapped=Human_model(i_wr).wrap;
0553                             <span class="keyword">for</span> k_wr=1:size(Solid_wrapped,2)
0554                                 Wrap(j_wr)=Solid_wrapped(k_wr);
0555                                 j_wr=j_wr+1;
0556                             <span class="keyword">end</span>
0557                         <span class="keyword">end</span>
0558                     <span class="keyword">end</span>
0559                     names = {Wrap.name}'; [~,ind]=intersect(names,Muscles(mu).wrap{1});
0560                     cur_Wrap=Wrap(ind);
0561                     <span class="comment">% wrap object</span>
0562                     T_Ri_Rw=[cur_Wrap.orientation,cur_Wrap.location;[0 0 0],1];
0563                     T_R0_Rw = Human_model_bis(cur_Wrap.num_solid).Tc_R0_Ri*T_Ri_Rw;
0564                     <span class="comment">% pts in Rw</span>
0565                     pts_mu_inRw=T_R0_Rw\[pts_mu';ones(1,nbpts_mu)];
0566                     <span class="comment">% verify if wrap.</span>
0567                     <span class="keyword">for</span> imw=1:nbpts_mu-1
0568                         <span class="keyword">if</span> <a href="../../Functions/MuscleForces/Wrapping/Intersect_line_cylinder.html" class="code" title="function [bool]=Intersect_line_cylinder(P1,P2,R)">Intersect_line_cylinder</a>(pts_mu_inRw(1:3,imw)', pts_mu_inRw(1:3,imw+1)', cur_Wrap.R)
0569                             [L(f),~,~,pt_wrap_inRw(:,:,imw)]=<a href="../../Functions/MuscleForces/Wrapping/CylinderWrapping.html" class="code" title="function [L,Q,T,AnimPt_in_Rw,ind]=CylinderWrapping(P,S,R,ind)">CylinderWrapping</a>(pts_mu_inRw(1:3,imw), pts_mu_inRw(1:3,imw+1), cur_Wrap.R);
0570                             tmp=T_R0_Rw*[pt_wrap_inRw(:,:,imw)';ones(1,size(pt_wrap_inRw,1))];
0571                             pt_wrap(:,:,imw)=tmp(1:3,:)';
0572                             <span class="comment">% add the wrapping points</span>
0573                             nb_added_pts=size([pts_mu(imw,:);pt_wrap(:,:,imw)],1);
0574                             cur_Fmu = repmat([1 2],[nb_added_pts-1 1])+(0:nb_added_pts-2)'+size(Vmu,1);
0575                             Vmu=[Vmu;pts_mu(imw,:);pt_wrap(:,:,imw)];
0576                             Fmu =[Fmu; cur_Fmu]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0577                             CEmu=[CEmu; repmat(color_mus(mu,:),[nb_added_pts 1])]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0578                         <span class="keyword">else</span>
0579                             <span class="keyword">if</span> imw&gt;1
0580                                 cur_Fmu = [1 2]+size(Vmu,1);
0581                                 Fmu =[Fmu; cur_Fmu]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0582                             <span class="keyword">end</span>
0583                             Vmu=[Vmu ;pts_mu(imw,:)]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0584                             CEmu=[CEmu; color_mus(mu,:)]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0585                         <span class="keyword">end</span>
0586                     <span class="keyword">end</span>
0587                     cur_Fmu = repmat([0 1],[1 1])+size(Vmu,1);
0588                     Fmu =[Fmu; cur_Fmu]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0589                     Vmu=[Vmu ;pts_mu(<span class="keyword">end</span>,:)]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0590                     CEmu=[CEmu; color_mus]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0591                 <span class="keyword">else</span>
0592                     cur_Fmu = repmat([1 2],[nbpts_mu-1 1])+(0:nbpts_mu-2)'+size(Vmu,1);
0593                     Fmu =[Fmu; cur_Fmu]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0594                     Vmu=[Vmu ;pts_mu]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0595                     CEmu=[CEmu; repmat(color_mus,[nbpts_mu 1])]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0596                 <span class="keyword">end</span>
0597             <span class="keyword">end</span>
0598         <span class="keyword">end</span>
0599         <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0600                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span>
0601                 || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>) <span class="keyword">...</span>
0602                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>))
0603             finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0604             hmu=<a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(Fmu,Vmu,[],CEmu,1,2);
0605             copyobj(hmu,ax);
0606             close(finv);
0607         <span class="keyword">elseif</span> f==f_affich(1)
0608             hmu=<a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(Fmu,Vmu,[],CEmu,1,2);
0609         <span class="keyword">end</span>
0610         animStruct.Handles{f} = [animStruct.Handles{f} hmu hmu hmu];
0611         animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Faces'</span>,<span class="string">'Vertices'</span>,<span class="string">'FaceVertexCData'</span>};
0612         animStruct.Set{f} = {animStruct.Set{f}{:},Fmu,Vmu,CEmu};
0613         
0614 
0615         <span class="keyword">if</span> isfield(Human_model,<span class="string">'wrap'</span>)
0616             Fw=[];
0617             CEw=[];
0618             Vw=[];
0619             Wraps = [Human_model.wrap];
0620             
0621             <span class="keyword">for</span> i_w = 1:numel(Wraps)
0622                 num_solid=Wraps(i_w).num_solid;
0623                 <span class="keyword">if</span> ~isempty(intersect(concerned_bones,num_solid))
0624                     T_Ri_Rw=[Wraps(i_w).orientation,Wraps(i_w).location;[0 0 0],1];
0625                     X = Human_model_bis(num_solid).Tc_R0_Ri*T_Ri_Rw;
0626                     [Fcyl,Vcyl]=<a href="PlotCylinder.html" class="code" title="function [F,V]=PlotCylinder(r,h)">PlotCylinder</a>(Wraps(i_w).R,Wraps(i_w).h);
0627                     Vcyl_R0= (X*[Vcyl';ones(1,length(Vcyl))])';
0628                     tot_nb_F=length(Fw);
0629                     cur_nb_F=length(Fcyl);
0630                     tot_nb_V=length(Vw);
0631                     Fw((1:cur_nb_F)+tot_nb_F,:)=Fcyl+tot_nb_V;
0632                     Vw=[Vw ;Vcyl_R0(:,1:3)]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0633                 <span class="keyword">end</span>
0634             <span class="keyword">end</span>
0635             <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0636                     || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span><span class="comment">     </span>
0637                     || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>) <span class="keyword">...</span>
0638                     || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>))
0639                 finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0640                 hw=<a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(Fw,Vw,<span class="string">'c'</span>,<span class="string">'none'</span>,0.75);
0641                 copyobj(hw,ax);
0642                 close(finv);
0643             <span class="keyword">elseif</span> f==f_affich(1)
0644                 hw=<a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(Fw,Vw,<span class="string">'c'</span>,<span class="string">'none'</span>,0.75);
0645             <span class="keyword">end</span>
0646             animStruct.Handles{f} = [animStruct.Handles{f} hw];
0647             animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Vertices'</span>};
0648             animStruct.Set{f} = {animStruct.Set{f}{:},Vw};
0649         <span class="keyword">end</span>
0650         
0651         
0652         
0653         
0654         
0655         
0656     <span class="keyword">end</span>
0657     
0658     
0659     
0660     
0661     
0662     
0663     
0664     <span class="comment">%% Mass Centers</span>
0665     <span class="keyword">if</span> options.mass_centers_anim
0666         Vsms=[];
0667         <span class="keyword">if</span> ~options.AnatLandmark
0668             liste=Colors.num_s_mass_center;
0669         <span class="keyword">else</span>
0670             <span class="keyword">if</span>  isempty(options.Segment)
0671                 liste=Colors.num_s_mass_center;
0672             <span class="keyword">else</span>
0673                 liste=intersect(Colors.num_s_mass_center,options.Segment);
0674             <span class="keyword">end</span>
0675         <span class="keyword">end</span>
0676         <span class="keyword">for</span> j=liste
0677             X = (Human_model_bis(j).Tc_R0_Ri(1:3,4))';
0678             Vsms=[Vsms;X]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0679         <span class="keyword">end</span>
0680         temp_nb_ms=length(liste);
0681         <span class="keyword">if</span> f==f_affich(1) || (isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>))
0682             hmass = patch(ax,<span class="string">'Faces'</span>,1:temp_nb_ms,<span class="string">'Vertices'</span>,Vsms,<span class="string">'FaceColor'</span>,<span class="string">'none'</span>,<span class="string">'FaceVertexCData'</span>,Colors.C_ms(1:temp_nb_ms,:),<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
0683             hmass.Marker=<span class="string">'o'</span>;
0684             hmass.MarkerFaceColor=<span class="string">'flat'</span>;
0685             hmass.MarkerEdgeColor=<span class="string">'k'</span>;
0686             hmass.MarkerSize=6;
0687         <span class="keyword">end</span>
0688         animStruct.Handles{f}=[animStruct.Handles{f} hmass];
0689         animStruct.Props{f}={animStruct.Props{f}{:}, <span class="string">'Vertices'</span>};
0690         animStruct.Set{f}={animStruct.Set{f}{:},Vsms};
0691     <span class="keyword">end</span>
0692     
0693     <span class="comment">%% Global Mass Centers</span>
0694     <span class="keyword">if</span> options.Global_mass_center_anim
0695         CoM = <a href="../../Functions/Dynamics/CalcCoM.html" class="code" title="function com=CalcCoM(Human_model)">CalcCoM</a>(Human_model_bis);
0696         X = CoM';
0697         <span class="keyword">if</span> f==f_affich(1) || (isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp;  isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>))
0698             hGmass=patch(ax,<span class="string">'Faces'</span>,1,<span class="string">'Vertices'</span>,X,<span class="string">'FaceColor'</span>,<span class="string">'none'</span>,<span class="string">'FaceVertexCData'</span>,[34,139,34]/255,<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
0699             hGmass.Marker=<span class="string">'o'</span>;
0700             hGmass.MarkerFaceColor=<span class="string">'flat'</span>;
0701             hGmass.MarkerEdgeColor=<span class="string">'k'</span>;
0702             hGmass.MarkerSize=10;
0703         <span class="keyword">end</span>
0704         animStruct.Handles{f}=[animStruct.Handles{f} hGmass];
0705         animStruct.Props{f}={animStruct.Props{f}{:}, <span class="string">'Vertices'</span>};
0706         animStruct.Set{f}={animStruct.Set{f}{:},X};
0707     <span class="keyword">end</span>
0708     
0709     <span class="comment">%% Force Prediction points</span>
0710     <span class="keyword">if</span> options.Force_Prediction_points
0711         Vpt_p=[];
0712         <span class="keyword">for</span> j=1:Colors.NbPointsPrediction
0713             i_so=Colors.Prediction(j).num_solid;
0714             num_m=Colors.Prediction(j).num_markers;
0715             pt_pred=Human_model_bis(i_so).anat_position{num_m,2};
0716             X = Human_model_bis(i_so).Tc_R0_Ri*[pt_pred;1];
0717             Vpt_p=[Vpt_p;X(1:3)']; <span class="comment">%#ok&lt;AGROW&gt;</span>
0718         <span class="keyword">end</span>
0719         <span class="keyword">if</span> f==f_affich(1) || isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>)
0720             hmass = patch(ax,<span class="string">'Faces'</span>,1:Colors.NbPointsPrediction,<span class="string">'Vertices'</span>,Vpt_p,<span class="string">'FaceColor'</span>,<span class="string">'none'</span>,<span class="string">'FaceVertexCData'</span>,Colors.C_pt_p,<span class="string">'EdgeColor'</span>,<span class="string">'none'</span>);
0721             hmass.Marker=<span class="string">'o'</span>;
0722             hmass.MarkerFaceColor=<span class="string">'flat'</span>;
0723             hmass.MarkerEdgeColor=<span class="string">'k'</span>;
0724             hmass.MarkerSize=6;
0725         <span class="keyword">end</span>
0726         animStruct.Handles{f}=[animStruct.Handles{f} hmass];
0727         animStruct.Props{f}={animStruct.Props{f}{:}, <span class="string">'Vertices'</span>};
0728         animStruct.Set{f}={animStruct.Set{f}{:},Vpt_p};
0729     <span class="keyword">end</span>
0730     
0731     <span class="comment">%% Scapulo-thoracic Ellipsoid</span>
0732     <span class="keyword">if</span> options.ellipsoid_anim
0733         <span class="comment">%&amp;&amp; sum(cellfun(@isempty,[Muscles.wrap]'))==0</span>
0734         Fe=[];
0735         CEe=[];
0736         Ve=[];
0737         num_solid=7;
0738         
0739         <span class="keyword">for</span> i_w = 1:2
0740             pos_ell=Human_model_bis(7).anat_position{8+i_w, 2};
0741             T_Ri_Rw=[eye(3,3), pos_ell;[0 0 0],1];
0742             X = Human_model_bis(num_solid).Tc_R0_Ri*T_Ri_Rw;
0743             [xel1,yel1,zel1]=ellipsoid(0,0,0,1.8/1.7*0.07,1.8/1.7*0.15,1.8/1.7*0.07);
0744             [Fel1,Vel1]=surf2patch(xel1,yel1,zel1);
0745             Vell_R0= (X*[Vel1';ones(1,length(Vel1))])';
0746             
0747             tot_nb_F=length(Fe);
0748             cur_nb_F=length(Fel1);
0749             tot_nb_V=length(Ve);
0750             Fe((1:cur_nb_F)+tot_nb_F,:)=Fel1+tot_nb_V;
0751             Ve=[Ve ;Vell_R0(:,1:3)]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0752         <span class="keyword">end</span>
0753         <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp;  (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0754                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span><span class="comment">                </span>
0755                 || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>) <span class="keyword">...</span>
0756                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>))
0757             finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0758             he=<a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(Fe,Ve,<span class="string">'c'</span>,<span class="string">'none'</span>,0.3);
0759             copyobj(he,ax);
0760             close(finv);
0761         <span class="keyword">elseif</span> f==f_affich(1)
0762             he=<a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(Fe,Ve,<span class="string">'c'</span>,<span class="string">'none'</span>,0.3);
0763         <span class="keyword">end</span>
0764         animStruct.Handles{f} = [animStruct.Handles{f} he];
0765         animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Vertices'</span>};
0766         animStruct.Set{f} = {animStruct.Set{f}{:},Ve};
0767     <span class="keyword">end</span>
0768     
0769     <span class="comment">%% Muscle wraps</span>
0770     <span class="keyword">if</span> options.wrap_anim &amp;&amp; isfield(Human_model,<span class="string">'wrap'</span>) &amp;&amp; numel([Human_model.wrap])&gt;0
0771         <span class="comment">%&amp;&amp; sum(cellfun(@isempty,[Muscles.wrap]'))==0</span>
0772         Fw=[];
0773         CEw=[];
0774         Vw=[];
0775         Wraps = [Human_model.wrap];
0776         
0777         <span class="keyword">for</span> i_w = 1:numel(Wraps)
0778             num_solid=Wraps(i_w).num_solid;
0779             T_Ri_Rw=[Wraps(i_w).orientation,Wraps(i_w).location;[0 0 0],1];
0780             X = Human_model_bis(num_solid).Tc_R0_Ri*T_Ri_Rw;
0781             [Fcyl,Vcyl]=<a href="PlotCylinder.html" class="code" title="function [F,V]=PlotCylinder(r,h)">PlotCylinder</a>(Wraps(i_w).R,Wraps(i_w).h);
0782             Vcyl_R0= (X*[Vcyl';ones(1,length(Vcyl))])';
0783             tot_nb_F=length(Fw);
0784             cur_nb_F=length(Fcyl);
0785             tot_nb_V=length(Vw);
0786             Fw((1:cur_nb_F)+tot_nb_F,:)=Fcyl+tot_nb_V;
0787             Vw=[Vw ;Vcyl_R0(:,1:3)]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0788         <span class="keyword">end</span>
0789         <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0790                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span><span class="comment">               </span>
0791                 || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>) <span class="keyword">...</span>
0792                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>))
0793             finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0794             hw=<a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(Fw,Vw,<span class="string">'c'</span>,<span class="string">'none'</span>,0.75);
0795             copyobj(hw,ax);
0796             close(finv);
0797         <span class="keyword">elseif</span> f==f_affich(1)
0798             hw=<a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(Fw,Vw,<span class="string">'c'</span>,<span class="string">'none'</span>,0.75);
0799         <span class="keyword">end</span>
0800         animStruct.Handles{f} = [animStruct.Handles{f} hw];
0801         animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Vertices'</span>};
0802         animStruct.Set{f} = {animStruct.Set{f}{:},Vw};
0803     <span class="keyword">end</span>
0804     
0805     <span class="comment">%% Muscles</span>
0806     <span class="keyword">if</span> options.muscles_anim &amp;&amp; ~isempty(Muscles) &amp;&amp; sum([Muscles.exist])
0807         Fmu=[];
0808         CEmu=[];
0809         Vmu=[];
0810         color_mus = Colors.color0 + Colors.Aopt(:,f)*(Colors.color1 - Colors.color0);
0811         ind_mu=find([Muscles_test.exist]==1);
0812         <span class="keyword">for</span> i_mu = 1:numel(ind_mu)
0813             mu=ind_mu(i_mu);
0814             pts_mu = Muscles_test(mu).pos_pts';
0815             nbpts_mu = size(pts_mu,1);
0816 <span class="comment">%             if  isfield(Muscles(mu),'wrap') &amp;&amp; ~isempty(Muscles(mu).wrap) &amp;&amp; ~isempty(Muscles(mu).wrap{1})</span>
0817 <span class="comment">%                 % find the wrap</span>
0818 <span class="comment">%                 Wrap = [Human_model.wrap]; names = {Wrap.name}'; [~,ind]=intersect(names,Muscles(mu).wrap{1});</span>
0819 <span class="comment">%                 cur_Wrap=Wrap(ind);</span>
0820 <span class="comment">%                 % wrap object</span>
0821 <span class="comment">%                 T_Ri_Rw=[cur_Wrap.orientation,cur_Wrap.location;[0 0 0],1];</span>
0822 <span class="comment">%                 T_R0_Rw = Human_model_bis(cur_Wrap.num_solid).Tc_R0_Ri*T_Ri_Rw;</span>
0823 <span class="comment">%                 % pts in Rw</span>
0824 <span class="comment">%                 pts_mu_inRw=T_R0_Rw\[pts_mu';ones(1,nbpts_mu)];</span>
0825 <span class="comment">%                 % verify if wrap.</span>
0826 <span class="comment">%                 for imw=1:nbpts_mu-1</span>
0827 <span class="comment">%                     if Intersect_line_cylinder(pts_mu_inRw(1:3,imw)', pts_mu_inRw(1:3,imw+1)', cur_Wrap.R)</span>
0828 <span class="comment">%                         [L(f),~,~,pt_wrap_inRw(:,:,imw)]=CylinderWrapping(pts_mu_inRw(1:3,imw), pts_mu_inRw(1:3,imw+1), cur_Wrap.R);</span>
0829 <span class="comment">%                         tmp=T_R0_Rw*[pt_wrap_inRw(:,:,imw)';ones(1,size(pt_wrap_inRw,1))];</span>
0830 <span class="comment">%                         pt_wrap(:,:,imw)=tmp(1:3,:)';</span>
0831 <span class="comment">%                         % add the wrapping points</span>
0832 <span class="comment">%                         nb_added_pts=size([pts_mu(imw,:);pt_wrap(:,:,imw)],1);</span>
0833 <span class="comment">%                         cur_Fmu = repmat([1 2],[nb_added_pts-1 1])+(0:nb_added_pts-2)'+size(Vmu,1);</span>
0834 <span class="comment">%                         Vmu=[Vmu;pts_mu(imw,:);pt_wrap(:,:,imw)];</span>
0835 <span class="comment">%                         Fmu =[Fmu; cur_Fmu]; %#ok&lt;AGROW&gt;</span>
0836 <span class="comment">%                         CEmu=[CEmu; repmat(color_mus(mu,:),[nb_added_pts 1])]; %#ok&lt;AGROW&gt;</span>
0837 <span class="comment">%                     else</span>
0838 <span class="comment">%                         if imw&gt;1</span>
0839 <span class="comment">%                             cur_Fmu = [1 2]+size(Vmu,1);</span>
0840 <span class="comment">%                             Fmu =[Fmu; cur_Fmu]; %#ok&lt;AGROW&gt;</span>
0841 <span class="comment">%                         end</span>
0842 <span class="comment">%                         Vmu=[Vmu ;pts_mu(imw,:)]; %#ok&lt;AGROW&gt;</span>
0843 <span class="comment">%                         CEmu=[CEmu; color_mus(mu,:)]; %#ok&lt;AGROW&gt;</span>
0844 <span class="comment">%                     end</span>
0845 <span class="comment">%                 end</span>
0846 <span class="comment">%                 cur_Fmu = repmat([0 1],[1 1])+size(Vmu,1);</span>
0847 <span class="comment">%                 Fmu =[Fmu; cur_Fmu]; %#ok&lt;AGROW&gt;</span>
0848 <span class="comment">%                 Vmu=[Vmu ;pts_mu(end,:)]; %#ok&lt;AGROW&gt;</span>
0849 <span class="comment">%                 CEmu=[CEmu; color_mus(mu,:)]; %#ok&lt;AGROW&gt;</span>
0850 <span class="comment">%             else</span>
0851                 cur_Fmu = repmat([1 2],[nbpts_mu-1 1])+(0:nbpts_mu-2)'+size(Vmu,1);
0852                 Fmu =[Fmu; cur_Fmu]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0853                 Vmu=[Vmu ;pts_mu]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0854                 CEmu=[CEmu; repmat(color_mus(mu,:),[nbpts_mu 1])]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0855  <span class="comment">%           end</span>
0856             
0857         <span class="keyword">end</span>
0858         <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0859                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span>
0860                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>)<span class="keyword">...</span>
0861                 || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>))
0862             finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0863             hmu=<a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(Fmu,Vmu,[],CEmu,1,2);
0864             copyobj(hmu,ax);
0865             close(finv);
0866         <span class="keyword">elseif</span> f==f_affich(1)
0867             hmu=<a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(Fmu,Vmu,[],CEmu,1,2);
0868         <span class="keyword">end</span>
0869         animStruct.Handles{f} = [animStruct.Handles{f} hmu hmu hmu];
0870         animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Faces'</span>,<span class="string">'Vertices'</span>,<span class="string">'FaceVertexCData'</span>};
0871         animStruct.Set{f} = {animStruct.Set{f}{:},Fmu,Vmu,CEmu};
0872     <span class="keyword">end</span>
0873     
0874     <span class="comment">%% Vectors of external forces issued from experimental data</span>
0875     <span class="keyword">if</span> options.external_forces_anim
0876         extern_forces_f = Colors.external_forces(f).Visual;
0877         F_ef=[];V_ef=[];
0878         <span class="keyword">for</span> i_for=1:size(extern_forces_f,2)
0879             <span class="keyword">if</span> norm(extern_forces_f(4:6,i_for)) &gt; 50
0880                 X_array=[extern_forces_f(1,i_for),<span class="keyword">...</span>
0881                     extern_forces_f(1,i_for) + extern_forces_f(4,i_for)/Colors.coef_f_visual];
0882                 Y_array=[extern_forces_f(2,i_for),<span class="keyword">...</span>
0883                     extern_forces_f(2,i_for) + extern_forces_f(5,i_for)/Colors.coef_f_visual];
0884                 Z_array=[extern_forces_f(3,i_for),<span class="keyword">...</span>
0885                     extern_forces_f(3,i_for) + extern_forces_f(6,i_for)/Colors.coef_f_visual];
0886                 F_ef = [F_ef; [1 2]+size(V_ef,1)]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0887                 V_ef = [V_ef; [X_array' Y_array' Z_array']]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0888             <span class="keyword">end</span>
0889         <span class="keyword">end</span>
0890         <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0891                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span>
0892                 || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>) <span class="keyword">...</span>
0893                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>))
0894             finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0895             Ext = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_ef,V_ef,[],Colors.color_vect_force,1,4);
0896             copyobj(Ext,ax);
0897             close(finv);
0898         <span class="keyword">elseif</span> f==f_affich(1)
0899             Ext = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_ef,V_ef,[],Colors.color_vect_force,1,4);
0900         <span class="keyword">end</span>
0901         animStruct.Handles{f} = [animStruct.Handles{f} Ext];
0902         animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Vertices'</span>};
0903         animStruct.Set{f} = {animStruct.Set{f}{:},V_ef};
0904     <span class="keyword">end</span>
0905     
0906     <span class="comment">%% Vectors of external forces issued from prediction</span>
0907     <span class="keyword">if</span> options.external_forces_p
0908         extern_forces_f = Colors.external_forces_pred(f).Visual;
0909         F_efp=[];V_efp=[];
0910         <span class="keyword">for</span> i_for=1:size(extern_forces_f,2)
0911             <span class="keyword">if</span> norm(extern_forces_f(4:6,i_for)) &gt; 50
0912                 X_array=[extern_forces_f(1,i_for),<span class="keyword">...</span>
0913                     extern_forces_f(1,i_for) + extern_forces_f(4,i_for)/Colors.coef_f_visual];
0914                 Y_array=[extern_forces_f(2,i_for),<span class="keyword">...</span>
0915                     extern_forces_f(2,i_for) + extern_forces_f(5,i_for)/Colors.coef_f_visual];
0916                 Z_array=[extern_forces_f(3,i_for),<span class="keyword">...</span>
0917                     extern_forces_f(3,i_for) + extern_forces_f(6,i_for)/Colors.coef_f_visual];
0918                 F_efp = [F_efp; [1 2]+size(V_efp,1)]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0919                 V_efp = [V_efp; [X_array' Y_array' Z_array']]; <span class="comment">%#ok&lt;AGROW&gt;</span>
0920             <span class="keyword">end</span>
0921         <span class="keyword">end</span>
0922         <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; (isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>) <span class="keyword">...</span>
0923                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateParameters'</span>) <span class="keyword">...</span>
0924                 || isequal(AnimateParameters.Mode, <span class="string">'Modelling'</span>) <span class="keyword">...</span>
0925                 || isequal(AnimateParameters.Mode, <span class="string">'GenerateAnimate'</span>))
0926             finv = figure(<span class="string">'visible'</span>,<span class="string">'off'</span>);
0927             Extp = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_efp,V_efp,[],Colors.color_vect_force_p,1,4);
0928             copyobj(Extp,ax);
0929             close(finv);
0930         <span class="keyword">elseif</span> f==f_affich(1)
0931             Extp = <a href="../../Functions/ExternLibrary/GIBBON/functions/gpatch.html" class="code" title="function [varargout]=gpatch(varargin)">gpatch</a>(F_efp,V_efp,[],Colors.color_vect_force_p,1,4);
0932         <span class="keyword">end</span>
0933         animStruct.Handles{f} = [animStruct.Handles{f} Extp];
0934         animStruct.Props{f} = {animStruct.Props{f}{:},<span class="string">'Vertices'</span>};
0935         animStruct.Set{f} = {animStruct.Set{f}{:},V_efp};
0936     <span class="keyword">end</span>
0937     
0938     <span class="comment">%% Display force plates position</span>
0939     <span class="keyword">if</span> options.forceplate
0940         <span class="keyword">if</span> isequal(AnalysisParameters.ExternalForces.Method, @<a href="../../Functions/ExternalForces/FromExperiments/DataInC3D.html" class="code" title="function [ExternalForcesComputationResults] = DataInC3D(filename, BiomechanicalModel, AnalysisParameters)">DataInC3D</a>)
0941             x_fp = []; y_fp = []; z_fp = [];
0942             <span class="keyword">for</span> i=1:numel(ForceplatesData)
0943                 <span class="keyword">if</span> ~isequal(AnalysisParameters.ExternalForces.Options{i}, <span class="string">'NoContact'</span>)
0944                     x_fp = [x_fp ForceplatesData(i).corners(1,:)'/1000]; <span class="comment">%#ok&lt;AGROW&gt; % mm -&gt; m</span>
0945                     y_fp = [y_fp ForceplatesData(i).corners(2,:)'/1000]; <span class="comment">%#ok&lt;AGROW&gt; % mm -&gt; m</span>
0946                     z_fp = [z_fp ForceplatesData(i).corners(3,:)'/1000]; <span class="comment">%#ok&lt;AGROW&gt; % mm -&gt; m</span>
0947                 <span class="keyword">end</span>
0948             <span class="keyword">end</span>
0949         <span class="keyword">elseif</span> isequal(AnalysisParameters.ExternalForces.Method, @PF_IRSST)
0950             x_fp = ExperimentalData.CoinsPF(1,:)/1000; <span class="comment">% mm -&gt; m</span>
0951             y_fp = ExperimentalData.CoinsPF(2,:)/1000; <span class="comment">% mm -&gt; m</span>
0952             z_fp = ExperimentalData.CoinsPF(3,:)/1000; <span class="comment">% mm -&gt; m</span>
0953         <span class="keyword">end</span>
0954         patch(ax,x_fp,y_fp,z_fp,[1 1 1]);
0955     <span class="keyword">end</span>
0956     
0957     <span class="comment">%% Base of support</span>
0958     <span class="keyword">if</span> options.BoS
0959         <span class="keyword">if</span> numel(InverseKinematicsResults.BoS{1,f})
0960             x_bos = InverseKinematicsResults.BoS{1,f}(1,:);
0961             y_bos = InverseKinematicsResults.BoS{1,f}(2,:);
0962             z_bos = InverseKinematicsResults.BoS{1,f}(3,:);
0963             patch(ax,x_bos,y_bos,z_bos,[1 .4 0]);
0964         <span class="keyword">end</span>
0965     <span class="keyword">end</span>
0966     
0967     <span class="comment">%% Save figure</span>
0968     <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; isequal(AnimateParameters.Mode, <span class="string">'Figure'</span>)
0969         <span class="comment">% drawing an saving</span>
0970         drawnow;
0971         animStruct.M(f) = getframe(fig); <span class="comment">%#ok&lt;AGROW&gt;</span>
0972     <span class="keyword">end</span>
0973     
0974     <span class="keyword">if</span> isfield(AnimateParameters,<span class="string">'Mode'</span>)  &amp;&amp; isequal(AnimateParameters.Mode, <span class="string">'Picture'</span>)
0975         saveas(fig,[filename <span class="string">'_'</span> num2str(f)],<span class="string">'png'</span>);
0976         close(fig);
0977     <span class="keyword">end</span>
0978     
0979 <span class="keyword">end</span>
0980 
0981 
0982 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Wed 28-Apr-2021 14:02:00 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>